---
title: "GRL Main Figures"
author: "Brandon M. Genco"
date: "10/21/2021"
output: html_document
---

# Notes
*  
see "plotting 2018 maps 1" for lyx eps figures of mapped with stations (FIG 1 C & D)
* for europa, loading v_rgb object created a plotting issue with ggRGB
** so load v_rgb tiff instead of r oboj
## Figure  style notes
* EPS final (PS, TIFF, PDF)
* use lowercase letter for panels
* Lat and long on all maps
* "When possible, include the figure label in the top left corner of each plot"
* "Do not include information in a figure that could easily be included in the caption."

Recommended fonts: **Same as Paper**
* **Arial - chosen for now **
* Helvetica
* Times
* symbol

## Choose Fonts
https://stackoverflow.com/questions/51885427/font-family-wont-change-in-ggplot/51888677#51888677

https://stackoverflow.com/questions/34522732/changing-fonts-in-ggplot2


# Packages, Directories

# dynamic

```{r setup}
rm(list=ls())
# relative directories
robj<-"r_objects"
fig<-"../../figures"
gis_data<-"../../data/gis_data"
data_d<-"../../data/2018_data"
# data_d<-"../../data"
ocean_color<-"../../data/ocean_color_bud"
bathy_d<-"../../data/bathy" # edit this


# old NC files
aqua_directory<-"../../data/ocean_color_bud/aqua"
terra_directory<-"../../data/ocean_color_bud/terra"
viirs_directory<-"../../data/ocean_color_bud/terra"

#absolute directory
drop_img<-"/home/brandon/Dropbox/MERCED/dissertation/presentations/images"

knitr::opts_chunk$set(echo =FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```


## Load Packages
* Change 'packages' vector accordingly
* change font type
* to do trim uneeded package

```{r}
wd<-getwd()
f.ipak <- function(pkg){
  
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}
packages<-c("stars", "gridExtra", "cowplot", "sf", "ggspatial","stringr","sp", "rgdal",  "rgeos", "raster","readr" ,"tidyverse", "ggplot2", "lubridate",  "ggthemes", "data.table", "reshape2", "patchwork", "RColorBrewer", "marmap", "extrafont", "oce", "ncdf4", "raster", "RStoolbox", "cmocean", "metR",  "grImport2", "scales")  # set packages here

# "ggimage",

f.ipak(packages)

print(paste0("Current Working Directory is ", getwd()))

```

## Set Directories
* Currently machine "?"


### Vesta
```{r setup}
# wd<-"/home/brandon/vestawd/omz/wd/r_wd"

setwd("..")
wd<-getwd()

robj<-"./r_objects"
fig<-"../../figures"
gis_data<-"../../data/gis_data"
data_d<-"../../data/2018_data"
ocean_color<-"../../data/ocean_color_bud"
bathy_d<-"../../data/bathy" # edit this

aqua_directory<-"../../data/ocean_color_bud/aqua"
terra_directory<-"../../data/ocean_color_bud/terra"
viirs_directory<-"../../data/ocean_color_bud/terra"
 "../../data/ocean_color_bud/true_color/viirs"


# lyx_fig<-"/home/brandon/vestawd/omz/r_wd/lyx_figures"

knitr::opts_knit$set(root.dir=wd)
print("Computer = Vesta")
```



### Europa

```{r setup}
wd<-"/home/brandon/Desktop/omz/r_wd"
fdata<-"/home/brandon/Desktop/omz/2018_data/fluor/OC1806A/129998/data"
robj<-"/home/brandon/Desktop/omz/r_wd/r_objects"
#wd<-"/home/brandon/vestawd/omz/r_wd"
#robj<-"/home/brandon/vestawd/omz/r_wd/r_objects"
fig<-"/home/brandon/Desktop/omz/r_wd/figures"
gis_data<-"/home/brandon/Desktop/omz/gis_data"
data_d<-"/home/brandon/Desktop/omz/2018_data"
ocean_color<-"/home/brandon/Desktop/omz/ocean_color_bud"
lyx_fig<-"/home/brandon/Desktop/omz/r_wd/lyx_figures"
#bathy_d<-"/home/brandon/vestawd/wd_ideal_error/data"
knitr::opts_knit$set(root.dir=wd)
print("Computer = Europa")

```



### Enceladus

```{r setup}
wd<-"C:/Users/brandon/Desktop/omz/r_wd"
fdata<-"C:/Users/brandon/Desktop/omz/2018_data/fluor/OC1806A/129998/data"
robj<-"C:/Users/brandon/Desktop/omz/r_wd/r_objects"
fig<-"C:/Users/brandon/Desktop/omz/r_wd/figures"
gis_data<-"C:/Users/brandon/Desktop/omz/gis_data"
data_d<-"C:/Users/brandon/Desktop/omz/2018_data"
ocean_color<-"C:/Users/brandon/Desktop/omz/ocean_color_bud"
lyx_fig<-"C:/Users/brandon/Desktop/omz/r_wd/lyx_figures"
knitr::opts_knit$set(root.dir=wd)
print("Computer = Enceladus")
```

# Load data
* split by similarity not figures

## Load Data 1- OC1806A 1 - Flow/ctd/stations ##
* slight difference in variable names as compared to input and analysis script
```{r}
setwd(robj)

#### Cruise data ###o
# flowthrough non-spatial
cruise_data<-readRDS("OC1806A_cruise_sensor_matchup.R")

# flowthrough mapped
mapped_cruise<-readRDS("OC1806A_mapped_cruise_sensor.R")

# CTD list object - sf object 
ctd_sections<-readRDS("OC1806A_ctd_sections.R")

# ctd_sections[[1]]->st1
# ctd_sections[[2]]->st2
# ctd_sections[[3]]->st3
# ctd_sections[[4]]->st3.5
# ctd_sections[[5]]->st4
# ctd_sections[[6]]->st5
# ctd_sections[[7]]->ocean_section # stations 2-4
# ctd_sections[[8]]->all


# stations positions list - non spatial
stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")
names(stations_positions_list)<-c("read_me", "flowthrough_stations", "ctd_centroids_stations")

# mapped stations - sf object 

stations_mapped<-readRDS("OC1806A_mapped_ctd_stations.R") # centroid of ctd casts


```

## Load Data 2 - Bathy/Coastline/ Hurricane Bud Track
```{r}
# global 5m resolution land polygon:  
setwd(wd)
setwd(gis_data)
coastline<-st_read("./ne_50m_land/ne_50m_land.shp") 

# premade NC bathymetric file for 
#setwd(bathy_d)
#bathy.stations<-raster("omz_stations.nc", varname="z") # pre cut Nc File


# bud track
setwd(wd)
setwd(robj)
bud_list<-readRDS("2018_hurricane_bud_track_data.R")

#bud_list[[1]]->read_me_bud
bud_list[[2]]->bud
bud_list[[3]]->bud_mapped


```

# Prep of plotting objects
## Stations  object "rects" & "centered" for S1 figure
* need to improve so I can use stations list object

```{r}
setwd(data_d)

stations<-read_csv("2018_time_and_station.csv")
names(stations)<-c("date", "hour", "station")
stations$station<-as.factor(stations$station)
stations[10,2]<-"0400"
stations$time<-mdy_hm(paste(stations$date, stations$hour, tz="UTC"))
stations$time<-with_tz(stations$time, tz="US/Mountain")
stations<-dplyr::select(stations, time, station)

stations<-dplyr::filter(stations, station != "Steam" & station != "Unknown")
stations<-droplevels(stations)
tz(stations$time)<-"US/Mountain"

start<-stations %>% group_by(station) %>% 
  filter(time== min(time)) %>%
  slice(1) %>% 
  ungroup()
start<-as.data.frame(start)

end<-stations %>% group_by(station) %>% 
  filter(time== max(time)) %>%
  slice(1) %>% 
  ungroup()
end<-as.data.frame(end)

rects<-dplyr::inner_join(start, end, by="station")
names(rects)<-c("x1", "station", "x2")
rm(start, end)

rects$y1<-Inf
rects$y2<-Inf
centered<-((rects$x2-rects$x1)/2)+rects$x1
rects$station<-c("Sta 1", "Sta 2", "Sta 3", "Sta 3.5", "Sta 4", "Sta 5" )
rm(stations)


```

## Bathymetry 

```{r}
#bathy.stations<-raster("omz_stations.nc", varname="z")
# bathy.stations<-as.bathy(bathy.stations)
# setwd(robj)
# saveRDS(bathy.stations, file="bathy.stations.rda")
# 
# setwd(robj)
# bathy<-readRDS("bathy.stations.rda")
# 
# ramp<-c("#2D3184", "#254289", "#1C518F", "#115F96", "#046C9C", "#0078A2", "#0084A7",
#         "#068FAB", "#189AAF", "#28A4B3", "#45B6B8", "#54BEBA", "#62C5BC", "#70CCBD", "#7DD2BF", 
#         "#8BD8C0", "#97DDC1", "#A3E2C3", "#AFE5C4", "#BAE9C6", "#C4EBC8", "#CDEECA", "#D6F0CD",
#         "#DEF1D0", "#E4F2D3", "#EAF2D6", "#EEF2DA", "#F2F2DE", "#F3F1E4")
# 
# sites<-sf:::as_Spatial(sites)
# labels<-layer(sp.text(coordinates(sites), txt = sites$station, pos = 1))
# 
# # save figure update here
# setwd(fig)
# bmp("omz_stations_and_bathymetery.bmp", res=300, height=4800, width=4800)
# plot(bathy.stations, bpal=ramp,  image=T, deep=c(-6500,0), shallow=c(-100,0),
#      step=c(200,0), lwd=c(0.4,0.8), lty=c(1,1))
# scaleBathy(bathy.stations, deg=1, x="topright")
# points(sites, pch=21, col="orange",bg=col2alpha("red",.7),cex=7)
# points(sites, pch=21, col="white", bg="white",cex=5)
# text(x=coordinates(sites)[1:6], y=coordinates(sites)[7:12],labels=sites$station, cex=1.5)
# dev.off()

```

## Spatial Data Wrangling
* Coastline polygon
* Station positions 

```{r}

#box<-st_bbox(mapped) #spatial extent of flowthrough data

cl<-st_crop(coastline, xmin=-170, ymin=-20, xmax=-80, ymax=40) # change here based on desired figure size

# sites<-st_as_sf(stations_positions_list$ctd_centroids, coords = c("longitude", "latitude"),
#           crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

```

# Main Figures
## Figure 1
### WOA create raster
* 
https://www.nodc.noaa.gov/OC5/SELECT/woaselect/woa_formats.html
## Plot 1
* Figure 1 Panel B?
* change 'xlim', and 'ylim' as needed
* lat/long white/blck rect

https://stackoverflow.com/questions/54868162/ggplot-panel-borders-alternating-black-and-white-rectangles

nc file from; https://www.ncei.noaa.gov/thredds-ocean/ncss/ncei/woa/oxygen/all/1.00/woa18_all_o00_01.nc/dataset.html

https://stackoverflow.com/questions/50119592/plot-bathymetry-and-coastline-using-ggplot2-and-marmap

ggplot apporach no marmap needed.
 https://eliocamp.github.io/metR/reference/geom_text_contour.html


From Paulmer and Ruiz-Pino:
Eastern Tropical North Pacific (ETNP): (0–25°N; 75– 180°W)
Eastern Sub- Tropical North Pacific (ESTNP): (25–52°N; 75–180°W)


```{r}
# setwd(data_d)
# x<-nc_open("WOA/woa18_all_o00_01.nc")
# o<-ncvar_get(x, "o_an")

setwd(data_d)
setwd("./ODV_exported")
woa<-read_tsv("isosurface_data.txt", skip=1) %>% select(., 'Depth [m]  at  Oxygen [ml/l]=0.45 @ Depth [m]  at  Oxygen [ml/l]=0.45=first', 'Longitude', "Latitude")
names(woa)<-c("depth", "lon", "lat")
woa$lon<-(360-woa$lon)*-1

woa.dataframe<-woa

woa<-SpatialPointsDataFrame(woa, coords=cbind(woa$lon, woa$lat),  proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
woa_r<-raster(ncols=length(unique(woa$lon)), nrows=length(unique(woa$lat)))

#### create GIS polygon ####
# comment out below
# Eastern Tropical North Pacific (ETNP): (0–25°N; 75– 180°W)

extent(woa_r)<-extent(-180, -60, 0, 33.5)
r<-raster(ncols=(6120), nrows=(6200))
extent(r)<-extent(-180, -60, 0, 33.5)
extent(r)<-extent(woa)


#### for figure ####

extent(woa_r)<-extent(-120, -100, 10, 33.5)
r<-raster(ncols=(612), nrows=(620))
extent(r)<-extent(-120, -100, 10, 35)
extent(r)<-extent(woa)

# woa_r<-rasterize(woa, woa_r, "depth", fun=mean)
woa_r<-rasterize(woa, woa_r, "depth", fun=last)
# woa_r2<-aggregate(woa_r, fact=c(1.1,1.1))
# woa_r2<-disaggregate(woa_r2, fact=c(1.1,1.1))
woa<-resample(woa_r, r, method="bilinear")

# for geom_contours
woa.fortify<-as.bathy(woa)%>%fortify(.)
rm(r)


```

### GGplot of coast line
* Used for mapped figures (Fig1)

```{r}
m.coast <- ggplot()+ geom_sf(data =cl, size=0.5)+ theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
  theme_bw()+ theme(text = element_text(size =12)) 
```


### Bud prep and figure 1 prep..
8 may be some duplication but it should work
* will ned to adjust for use on compouters onther than vesta
*is a hack right now
# dont need to do anymore

```{r}
# # mapped data com back here
# setwd(wd)
# setwd("r_objects_back_up")
# full<-readRDS('data.R')
# full<-dplyr::select(full, time, lat, lon)
# full$date<-date(full$time)
# full$time<-with_tz(full$time, tz="UTC")
# full$date<-with_tz(full$date, tz="UTC")
# 
# full.days<-unique(full$date)
# full.days<-full.days %>% .[-1] %>% .[-(length(.))] # 
# 
# sixhourselect<-ymd_hms(paste(sort(rep(full.days,4)), rep(c("00:00:00", "06:00:00", "12:00:00", "18:00:00"), length(full.days))))
# # sixhourselect<-unique(sixhourselect)
# 
# 
# full<-dplyr::select(full, time, lat, lon)
# 
# sixhourselect<-as.data.frame(sixhourselect)
# names(sixhourselect)<-"time"
# full$timenumb<-as.integer(full$time)
# sixhourselect$timenumb<-as.integer(sixhourselect$time)
# 
# setDT(full)
# setDT(sixhourselect)
# setkey(full, timenumb)
# setkey(sixhourselect, timenumb)
# 
# full<-full[sixhourselect, roll='nearest']
# #full<-full[-1,] # drop repeat
# rm(sixhourselect)
# 
# full<-dplyr::select(full, time, lat, lon) 
# 
# full[, "print_date"]<-NA
# full$hour<-unlist(str_extract_all(unlist(str_extract_all(as.character(full$time),pattern=".{8}$" )), pattern=".{5}"))
# 
# t1<-which(full$hour=="18:00") # for some reason get some odd values for 18:005
# full$day<-day(full$time)
# full$print_date[t1]<-full$day[t1]
# # hardcoding hack
# full$print_date[36]<-full$day[36] #18
# full$print_date[40]<-full$day[40] #19
# 
# rm(t1)
# 
# mapped_fig1<-st_as_sf(full, coords = c("lon", "lat"),
#                  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# #bud
# setwd(data_d)
# bud<-read_csv("hurricane_bud/bud_hurdat2.csv", skip = 1, col_names = F)
# bud <- bud[,-21]
# 
# hurdat2_names <- c("date", "hour_minute", "record_id", 'storm_status', "lat", 'lon', "max_sustained_wind_knots", "min_pressure_millibars", "34_ne", "34_se", "34_sw", "34_nw", "50_ne", "50_se", "50_sw", "50_nw", "64_ne", "64_se", "64_sw", "64_nw")
# names(bud) <- hurdat2_names
# rm(hurdat2_names)
# str(bud)
# 
# bud$lat<-as.numeric(str_extract_all(bud$lat, '[:digit:][:digit:][:punct:][:digit:]', simplify = T))
# bud$lon<-(as.numeric(str_extract_all(bud$lon, '[:digit:][:digit:][:digit:][:punct:][:digit:]', simplify = T))) * -1
# 
# # time conversion
# bud$date <- as.character(bud$date)
# bud$time<-ymd_hm(paste(bud$'date', bud$'hour_minute', tz="UTC"))
# bud$storm_status<-as.factor(bud$storm_status)
# 
# bud[, "print_date"]<-NA
# t1<-which(bud$hour_minute=="1800")
# bud$print_date[t1]<-bud$date[t1]
# bud$print_date<-day(ymd(bud$print_date))
# 
# bud_fig1<-bud
# 
# mapped_fig1$time<-with_tz(mapped_fig1$time, tz="US/Mountain")
# bud_fig1$time<-with_tz(bud_fig1$time, tz="US/Mountain")
# 
# bud_fig1<-st_as_sf(bud_fig1, coords = c("lon", "lat"),
#                  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# mapped_fig1<-st_as_sf(mapped_fig1, coords = c("lon", "lat"),
#                  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# 
# rm(t1,bud, full)
# 
# 
# d10<-which(mapped_fig1$print_date==10)
# d11<-which(mapped_fig1$print_date==11)
# d12<-which(mapped_fig1$print_date==12)
# d13<-which(mapped_fig1$print_date==13)
# d14<-which(mapped_fig1$print_date==14)
# d15<-which(mapped_fig1$print_date==15)
# d16<-which(mapped_fig1$print_date==16)
# d17<-which(mapped_fig1$print_date==17)
# d18<-which(mapped_fig1$print_date==18)
# d19<-which(mapped_fig1$print_date==19)
# d20<-which(mapped_fig1$print_date==20)
# bd15<-which(bud_fig1$print_date==15)
# 
# mapped_fig1$print_date_n<-mapped_fig1$print_date 
# mapped_fig1$print_date_n[c(d10,d11,d12,d13,d14,d15,d16,d17,d18,d19,d20)]<-NA
# mapped_fig1$print_date[1]<-09
# 
# bud_fig1$print_date_n<-bud_fig1$print_date
# bud_fig1$print_date_n[bd15]<-NA
# 
# #plotting: 
# 
# # m.coast <- ggplot()+ geom_sf(data =cl, size=2)+ theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
# #   theme_bw()+ theme(text = element_text(size = 20)) 
# 
# 
# #winds select that variable
# 
# bud_fig1<-dplyr::select(bud_fig1, max_sustained_wind_knots, print_date, print_date_n)
# conv<-1.94384 # convert to m/s
# bud_fig1$max_sustained_wind_knots<-bud_fig1$max_sustained_wind_knots/conv
# names(bud_fig1)<-c("max_sustained_wind_m_s", "print_date", "print_date_n", "geometry" )
# 
# 
# # 
# # 
# # setwd(robj)
# # saveRDS(mapped_fig1, "mapped_fig1.R")
# # saveRDS(bud_fig1, "bud_fig1.R")
# 

```


### ploting attmept one
```{r}
# # for stations mapped with diffrent graphical paramters on position and distance for indetifiying number
# 
# sitesa = stations_mapped[stations_mapped$station == c(4,5),] 
# sitesb = stations_mapped[stations_mapped$station == 2,] 
# sitesc = stations_mapped[stations_mapped$station == 3.5,]
# sitesd = stations_mapped[stations_mapped$station == 1,]
# sitese = stations_mapped[stations_mapped$station == 3,]
# 
# 
# # WOA maping  coordinates:
# # coord_sf(xlim = c(-120,-100), ylim = c(10, 35))
# 
# # stations maping coordiantes:
# # coord_sf(xlim = c(-118,-101), ylim = c(14.5, 33))
# 
# 
# # wind Not for main figure
# # m.w<-m.coast + theme(legend.position="top") + theme(legend.key.width = unit(1, 'in'))+
# #   ggtitle("Wind (knots)") + theme(plot.title = element_text(hjust = 0.5))+
# #   geom_sf(aes(colour=wind), shape = 20, size =2, data = mapped_cruise) + scale_color_gradient(low="orange", high="navyblue") + coord_sf(xlim = c(-118 -101), ylim = c(14.5, 33))
# 
# # 2 panel plottinh  but no lables  
# m.c<-m.coast + theme(legend.position="top") + theme(legend.key.width = unit(1, 'in')) + theme(legend.title = element_blank())+
#   ggtitle("Celsius") + theme(plot.title = element_text(hjust = 0.5))+
#   geom_sf(aes(colour=celsius), shape = 20, size =4, data = mapped_cruise) + scale_color_gradient(low="blue", high="red")+
#   geom_sf(data =sitesa, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitesa, size = 8) +
#   geom_sf(data =sitesb, shape =2, size =8) + geom_sf_text(aes(label = station), vjust=2, data= sitesb, size = 8) +
#   geom_sf(data =sitesc, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=1.75, data= sitesc, size = 8)+
#   geom_sf(data =sitesd, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=2.5, data= sitesd, size = 8) +
#   geom_sf(data =sitese, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitese,size = 8)+
#   #theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
#   coord_sf(xlim = c(-118,-101), ylim = c(14.5, 33))
# 
# m.f<-m.coast + theme(legend.position="top") + theme(legend.key.width = unit(1, 'in')) +theme(legend.title = element_blank())+
#   ggtitle("ChL") + theme(plot.title = element_text(hjust = 0.5))+
#   geom_sf(aes(colour=chlorophyll), shape = 20, size =4, data = mapped_cruise) + scale_color_gradient(low="azure2", high="darkgreen", name = "Chl")+
#   geom_sf(data =sitesa, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitesa, size = 8) +
#   geom_sf(data =sitesb, shape =2, size =8) + geom_sf_text(aes(label = station), vjust=2, data= sitesb, size = 8) +
#   geom_sf(data =sitesc, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=1.75, data= sitesc, size = 8)+
#   geom_sf(data =sitesd, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=2.5, data= sitesd, size = 8) +
#   geom_sf(data =sitese, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitese,size = 8)+
#   #theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
#   coord_sf(xlim = c(-118,-101), ylim = c(14.5, 33))
# 
# 


```

### ploting attmept two
*convert sp object tor raste panel c, d
* panel a 


```{r}
# for stations mapped with diffrent graphical paramters on position and distance for indetifiying number
# 
# sitesa = stations_mapped[stations_mapped$station == c(4,5),] 
# sitesb = stations_mapped[stations_mapped$station == 2,] 
# sitesc = stations_mapped[stations_mapped$station == 3.5,]
# sitesd = stations_mapped[stations_mapped$station == 1,]
# sitese = stations_mapped[stations_mapped$station == 3,]
# 
# 
# # WOA maping  coordinates:
# # coord_sf(xlim = c(-120,-100), ylim = c(10, 35))
# 
# # stations maping coordiantes:
# # coord_sf(xlim = c(-118,-101), ylim = c(14.5, 33))
# 
# 
# # wind Not for main figure
# # m.w<-m.coast + theme(legend.position="top") + theme(legend.key.width = unit(1, 'in'))+
# #   ggtitle("Wind (knots)") + theme(plot.title = element_text(hjust = 0.5))+
# #   geom_sf(aes(colour=wind), shape = 20, size =2, data = mapped_cruise) + scale_color_gradient(low="orange", high="navyblue") + coord_sf(xlim = c(-118 -101), ylim = c(14.5, 33))
# 
# 
# # raste attempt
# 
# 
# 
# 
# # 2 panel plottinh  but no lables  
# m.c<-m.coast + theme(legend.position="top") + theme(legend.key.width = unit(1, 'in')) + theme(legend.title = element_blank())+
#   ggtitle("Celsius") + theme(plot.title = element_text(hjust = 0.5))+
#   geom_sf(aes(colour=celsius), shape = 20, size =4, data = mapped_cruise) + scale_color_gradient(low="blue", high="red")+
#   geom_sf(data =sitesa, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitesa, size = 8) +
#   geom_sf(data =sitesb, shape =2, size =8) + geom_sf_text(aes(label = station), vjust=2, data= sitesb, size = 8) +
#   geom_sf(data =sitesc, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=1.75, data= sitesc, size = 8)+
#   geom_sf(data =sitesd, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=2.5, data= sitesd, size = 8) +
#   geom_sf(data =sitese, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitese,size = 8)+
#   #theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
#   coord_sf(xlim = c(-118,-101), ylim = c(14.5, 33))
# 
# m.f<-m.coast + theme(legend.position="top") + theme(legend.key.width = unit(1, 'in')) +theme(legend.title = element_blank())+
#   ggtitle("ChL") + theme(plot.title = element_text(hjust = 0.5))+
#   geom_sf(aes(colour=chlorophyll), shape = 20, size =4, data = mapped_cruise) + scale_color_gradient(low="azure2", high="darkgreen", name = "Chl")+
#   geom_sf(data =sitesa, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitesa, size = 8) +
#   geom_sf(data =sitesb, shape =2, size =8) + geom_sf_text(aes(label = station), vjust=2, data= sitesb, size = 8) +
#   geom_sf(data =sitesc, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=1.75, data= sitesc, size = 8)+
#   geom_sf(data =sitesd, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=2.5, data= sitesd, size = 8) +
#   geom_sf(data =sitese, shape =2, size =8) + geom_sf_text(aes(label = station), hjust=3, data= sitese,size = 8)+
#   #theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
#   coord_sf(xlim = c(-118,-101), ylim = c(14.5, 33))
# 
# 


```


### rasterization flow thorugh

```{r}
setwd(robj)
x<-readRDS("OC1806A_cruise_sensor_matchup.R")
# 
# track<-select(x, "lon", "lat")
#   ### create a raster##
# 
# # track<-st_as_sf(x, coords = c("lon", "lat"),
# #                  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# 
# track<-SpatialPointsDataFrame(track, coords=cbind(x$lon, x$lat),  proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
# r<-raster(ncols=(612), nrows=(620))
# extent(r)<-extent(-120, -100, 10, 35)
# track<-rasterize(track, r)


rasterize_flowthrough.f<-function(x, variable, ag_factor, md){
x<-select(x, "lon", "lat", variable)
x<-SpatialPointsDataFrame(x, coords=cbind(x$lon, x$lat),  proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

# ag_factor<-8 #
# md<-4
r<-raster(ncols=(612), nrows=(620))
extent(r)<-extent(-120, -100, 10, 35)

y<-rasterize(x, r, variable, fun=mean)
y1<-aggregate(y, fact=c(ag_factor,ag_factor))


d1<-raster(ncols=(612*ag_factor), nrows=(620*ag_factor))
extent(d1)<-extent(r)
d<-resample(y1, d1)


# s<-raster(ncols=612/2, nrows=620/2)
# extent(s)<-extent(r)
# test<-resample(w, s, method='bilinear')

m<-raster(ncol=md, nrow=md)
xs<-xres(d)

# here...
gf <- focalWeight(m, type="circle", d=(xs*md))
y<-focal(d, w=gf)
rm(y1,d1,d,m,xs,gf,r)
return(y)
}
#plot(q, main="test")

chl<-rasterize_flowthrough.f(x=x, variable="chlorophyll", ag_factor=8, md=4)
cel<-rasterize_flowthrough.f(x=x, variable="celsius", ag_factor=8, md=4)

# dont likely need...

# track<-rasterize_flowthrough.f(x=x, variable="wind", ag_factor=8, md=4)
# 
# x<-select(x, "lon", "lat", "celsius")
# x<-SpatialPointsDataFrame(x, coords=cbind(x$lon, x$lat),  proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
# r<-raster(ncols=(612), nrows=(620))
# track<-rasterize(x, r, "celsius", fun=last)
# extent(track)<-extent(cel)
# # values(track)[values(track) > 0]<-1
# track<-aggregate(track, fact=c(3,3))
# # track<-aggregate(track, factor=c(4,4))
# values(track)[values(track) > 0]<-1
# 

rm(x)
#### ploting ####

# parmaters from figure 2
# 
# cuts<-c(0, 0.01, 0.02, 0.04,  0.08,  0.1,  0.15, 0.2, 0.35, 0.5, 0.8, 0.9, 1, 2,3,4, 5)
# n<-length(cuts)+1
# custom_color<-rev(rainbow(n))
# cuts<-rescale(cuts)
# title_two<-expression(atop(textstyle(" Chl a "), textstyle(" mg M"^-3*"")))
# labs<-c(0.1, .5, 1, 2 , 2.5, 5)



####

```

#### creating curise track object.. 

```{r}
setwd(robj)
pos<-readRDS("OC1806A_gps.R")
track<-sp::SpatialPoints(cbind(pos$lon, pos$lat))
rm(pos)
proj4string(track)<-CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
track<-as(track, "SpatialLines")%>%st_as_sf(.)

```


### creating/printing four panel images -main section
use this one! (below, new fig margins etc)

Tod do'
*rmoeve excess white space
*remove islands from gis (afte I submit)

*adjust bud...bah

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# 
setwd(robj)
mapped_fig1<-readRDS("mapped_fig1.R")
bud_fig1<-readRDS("bud_fig1.R")

# station plotting defaults: #
site_size=3
symbol_size=3.5
shape_s<-1

track_size=.75

## legend defaults: #
width=1
height=14

marks.textsize=2
title.textsize=8
lp<-"right"

# title size

title.size=12
# cruise / bud track defaults

bud_size<-3
station_size<-1
station.shape<-20
text_size<-2
station_color<-"black"

# figure margins
t=0.5
r=0
l=0
b=.25

#### common ggplot objects (rewquirere woa object) #### 
sitesa = stations_mapped[stations_mapped$station == c(4,5),] 
sitesb = stations_mapped[stations_mapped$station == 2,] 
sitesc = stations_mapped[stations_mapped$station == 3.5,]
sitesd = stations_mapped[stations_mapped$station == 1,]
sitese = stations_mapped[stations_mapped$station == 3,]

s1<-geom_sf(data =sitesa, shape =shape_s, size =symbol_size)
s2<-geom_sf_text(aes(label = station), hjust=2.5, vjust=1, data= sitesa, size = site_size, fontface ="bold")
s3<-geom_sf(data =sitesb, shape =shape_s, size =symbol_size)  
s4<-geom_sf_text(aes(label = station), vjust=2, data= sitesb, size = site_size, fontface ="bold")
s5<-geom_sf(data =sitesc, shape =shape_s, size =symbol_size)
s6<-geom_sf_text(aes(label = station), hjust=1.5, data= sitesc, size = site_size, fontface ="bold")
s7<-geom_sf(data =sitesd, shape =shape_s, size =symbol_size)
s8<-geom_sf_text(aes(label = station), hjust=2.25, data= sitesd, size = site_size, fontface = "bold") 
s9<-geom_sf(data =sitese, shape =shape_s, size =symbol_size)
s10<-geom_sf_text(aes(label = station), hjust=2.25, data= sitese,size = site_size, fontface = "bold")

t1<-theme(text=element_text(family="Helvetica"))+ theme(legend.position=lp, plot.background = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(), plot.title = element_text(hjust = 0.5), plot.margin = unit(c(t, r, b, l), "cm"), legend.box.margin=margin(-15,-10,-10,-10))

# legend.box.margin=margin(-10,-10,-10,-10))

ex2<-scale_y_continuous(expand =expansion(mult=c(0, 0)))
a1<- scale_x_continuous(expand = c(0, 0), breaks=seq(-120, -100, b=05))

c1<-geom_sf(data =cl, size=0.5)
c2<-theme_bw()

left<-extent(woa)[1]
right<-extent(woa)[2]

top<-extent(woa)[4]
bottom<-extent(woa)[3]
left<-extent(woa)[1]
right<-extent(woa)[2]
y1<-ylim(bottom, top)
c3<-coord_sf(xlim = c(left,right), ylim = c(11.55, 32.45))

# l3<-theme(legend.title =element_text(size=title.textsize), legend.text=element_text(size=marks.textsize))
# l3<-guide_legend(legend.title =element_text(size=title.textsize), legend.text=element_text(size=marks.textsize))
# l4<-guides(size = guide_legend(title.position="top", title.hjust = 0.5))

# l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, 
#                                 barwidth = width, title.position = "top",  title.hjust = 0.5,
#                                 title.theme = element_text(size=title.textsize)), 
#                                 legend.text=element_text(size=marks.textsize))
  
# l3<-guides(fill = guide_legend(label.position = "top", label.hjust = 1))

n<-30 #color complexity

#### 1a MAP ####

#duplicated, from above code chunk
d10<-which(mapped_fig1$print_date==10)
d11<-which(mapped_fig1$print_date==11)
d12<-which(mapped_fig1$print_date==12)
d13<-which(mapped_fig1$print_date==13)
d14<-which(mapped_fig1$print_date==14)
d15<-which(mapped_fig1$print_date==15)
d16<-which(mapped_fig1$print_date==16)
d17<-which(mapped_fig1$print_date==17)
d18<-which(mapped_fig1$print_date==18)
d19<-which(mapped_fig1$print_date==19)
d20<-which(mapped_fig1$print_date==20)
bd15<-which(bud_fig1$print_date==15)

custom_color<-cmocean('matter', version="2.0")(n)
# station_color<-"#175d1c" # complimentary collor  for 'matter' see website: https://imagecolorpicker.com/color-code/222255

custom_color<-cmocean('matter', version="2.0")(n)

# title_two<-expression(textstyle("Max sustained wind speed m s"^-1*""))
# title_two<-expression(textstyle("Wind speed m s"^-1*""))
title_two<-expression(textstyle("Wind m s"^-1*""))

bud_color<-custom_color[(length(custom_color))]

l1<-scale_fill_gradientn(colors = custom_color ,  na.value=NA, name=waiver()) 
# l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width))
l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, 
                                barwidth = width, title.position = "top",  
                                # title.hjust = 0.5,
                                title.theme = element_text(size=title.textsize)), 
                                legend.text=element_text(size=marks.textsize))

p1a<-geom_sf(aes(fill=max_sustained_wind_m_s), data=bud_fig1,  shape=21, size=bud_size, color="white")
p1b<-scale_fill_gradientn(colours= custom_color) # works!!

# p2<-geom_sf(data=mapped_fig1, color=station_color, shape=station.shape, fill=station_color, size=station_size)
# p2<-geom_raster(data=track, aes(x=x, y=y), na.rm=T)
# # p2<-geom_raster(data=track, aes(x=x, y=y), fill=values, na.rm=T)
# p2<-geom_raster(data=track, aes(fill=map), na.rm=T)
# p2<-ggR(track, geom_raster = TRUE, ggObj = T)
# p2<-geom_sf(aes(fill=celsius), shape = 21, size =.5, data = mapped_cruise)

p2<-ggplot()+geom_sf(data=track, size=track_size)


b1<-geom_sf_text(aes(label = print_date_n), data=bud_fig1, size =text_size, hjust =-1.25, color =bud_color) 
b2<-geom_sf_text(aes(label = print_date), data=bud_fig1[bd15,], size =text_size, hjust=-.75, vjust=1.5, color =bud_color) 

d<-geom_sf_text(aes(label = print_date_n), data=mapped_fig1, size =text_size, hjust =2, color =station_color)

m10<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d10,], size =text_size, vjust=2.25, color =station_color)
m11<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d11,], size =text_size, hjust=1.4, vjust= -0.25, color =station_color)
m12<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d12,], size =text_size, hjust=2, color =station_color)
m13<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d13,], size =text_size, hjust=2, color =station_color)
m14<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d14,], size =text_size, hjust =0.25, vjust=2.25,  color =station_color)
m15<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d15,], size =text_size, vjust =2, hjust=1.5, color =station_color)
m16<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d16,], size =text_size, vjust =2, color =station_color)
m17<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d17,], size =text_size, vjust = 2.25, color =station_color)
m18<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d18,], size =text_size, vjust = -1, hjust=1, color =station_color)
m19<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d19,], size =text_size, hjust =2, angle =20, color =station_color)
m20<-geom_sf_text(aes(label = print_date), data=mapped_fig1[d20,], size =text_size, hjust =2, angle =-20, color =station_color)

# m.map<-m.coast+p2+p1a+p1b+ggtitle("Hurricane and Cruise Tracks")+theme(plot.title = element_text(size = title.size))+b1+b2+d+m10+m12+m13+m14+m16+m17+m19+m20+c3+l1+l2+t1+a1+y1

m.map<-m.coast+p2+p1a+p1b+ggtitle("Hurricane and Cruise Tracks")+theme(plot.title = element_text(size = title.size))+b1+b2+d+m10+m12+m13+m14+m16+m17+m19+m20+s1+s3+s5+s7+s9+c3+l1+l2+t1+a1+y1

# m.map<-p2+c1+c2+c3+p1a+p1b+ggtitle("Hurricane and Cruise Tracks")+theme(plot.title = element_text(size = title.size))+b1+b2+d+m10+m12+m13+m14+m16+m17+m19+m20+s1+s3+s5+s7+s9+c3+l1+l2+t1+a1+y1

m.map<-p2+c1+c2+p1a+p1b+ggtitle("Hurricane and Cruise Tracks")+theme(plot.title = element_text(size = title.size))+b1+b2+d+m10+m12+m13+m14+m16+m17+m19+m20+s1+s3+s5+s7+s9+c3+l1+l2+t1+a1+y1


#### 1b WOA  ####

custom_color<-cmocean('dense', version="2.0")(n)
custom_color<-custom_color[1:(length(custom_color)-4)]
title_two<-"Depth m"

l1<-scale_fill_gradientn(colors = custom_color ,  na.value=NA,limits=c(75,575), name=waiver(), labs<-c(75,150,200,300,400,500))
# l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width))
l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, 
                                barwidth = width, title.position = "top",  
                                # title.hjust = 0.5,
                                title.theme = element_text(size=title.textsize)), 
                                legend.text=element_text(size=marks.textsize))

top<-extent(woa)[4]
bottom<-extent(woa)[3]
left<-extent(woa)[1]
right<-extent(woa)[2]
y1<-ylim(bottom, top)
c3<-coord_sf(xlim = c(left,right), ylim = c(11.55, 32.45))

contour.size<-.5
contours<-geom_contour(aes(x=x, y=y, z=z), data=woa.fortify, colour="grey50", size=contour.size)
contour.text<-geom_text_contour(aes(x=x, y=y, z=z), stroke = 0.2, data=woa.fortify, size=2, stroke.colour="white", colour="black", label.placement =label_placement_fraction(frac=0.55))


# version 1
# p1<-ggR(woa, geom_raster = TRUE, ggObj = T)+ scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0)) + contours + contour.text + scale_fill_gradientn(colors = custom_color)
# m.woa<-p1+ggtitle("Depth of OMZ")+theme(plot.title = element_text(size = title.size))+ex2+s1+s2+s3+s4+s5+s6+s7+s8+s9+s10+l1+l2+c1+c2+c3+t1+a1+y1


# version 2

p1<-ggR(woa, geom_raster = TRUE, ggObj = T)+ scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0))+ scale_fill_gradientn(colors = custom_color)+contours
m.woa<-p1+ggtitle("Long-term average OMZ depth")+theme(plot.title = element_text(size = title.size))+ex2+s1+s2+s3+s4+s5+s6+s7+s8+s9+s10+l1+l2+c1+c2+c3+contour.text+t1+a1+y1




#### 1c CELSIUS ####

custom_color<-cmocean('thermal', version="2.0")(n)
custom_color<-custom_color[1:(length(custom_color)-4)]
# title_two<-"Temperature °C"
title_two<-"°C"

l1<-scale_fill_gradientn(colors = custom_color ,  na.value=NA, name=waiver()) 
# l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width))
l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, 
                                barwidth = width, title.position = "top",  
                                # title.hjust = 0.5,
                                title.theme = element_text(size=title.textsize)), 
                                legend.text=element_text(size=marks.textsize))

p1<-ggR(cel, geom_raster = TRUE, ggObj = T)+ scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0))+scale_fill_gradientn(colors = custom_color)

m.cel<-p1+ggtitle("SST Flowthrough")+theme(plot.title = element_text(size = title.size))+s1+s2+s3+s4+s5+s6+s7+s8+s9+s10+l1+l2+c1+c2+c3+t1+y1

#### 1d CHL  ####

custom_color<-cmocean('algae', version="2.0")(n)
custom_color<-custom_color[1:(length(custom_color)-4)]
title_two<-expression(atop(textstyle(" Chl a "), textstyle(" mg m"^-3*"")))

l1<-scale_fill_gradientn(colors = custom_color ,  na.value=NA, name=waiver()) 
# l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width))
l2<-guides(fill=guide_colourbar(title=title_two, barheight = height, 
                                barwidth = width, title.position = "top",  
                                # title.hjust = 0.5,
                                title.theme = element_text(size=title.textsize)), 
                                legend.text=element_text(size=marks.textsize))

p1<-ggR(chl, geom_raster = TRUE, ggObj = T)+
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +scale_fill_gradientn(colors = custom_color)

m.chl<-p1+ggtitle("Chlorophyll Flowthrough")+theme(plot.title = element_text(size = title.size))+s1+s2+s3+s4+s5+s6+s7+s8+s9+s10+l1+l2+c1+c2+c3+t1+y1

```

###b saving/ plotting figure to disk
new:
```{r}

setwd(fig)
pdf("figure_one_for_gimp.pdf", height=8.5 , width =11)
# plot_grid(m.map, m.woa, m.cel, m.chl, ncol=2, align="v")
plot_grid(m.map, m.woa, m.cel, m.chl, nrow=2, align="v", axis="b", labels="auto")
# plot_grid(
#   m.map, NULL, m.woa,
#   m.cel, NULL, m.chl
#   , nrow = 2
#   , rel_widths = c(1, 0.005, 1, 1, 0.005,1 )
#   , labels = c("a", "", "b", "c", "", "d")
# )

dev.off()

```


#### no longer used
```{r}
# setwd(fig)
# svg("figure_one_v1.svg", height=8.5 , width =11)
# plot_grid(m.map, m.woa, m.cel, m.chl, nrow=2, align="v", axis="b", labels="auto")
# dev.off()
```

doesn't make a difference
```{r}
# plot_grid(
#   m.map, NULL, m.woa,
#   m.cel, NULL, m.chl
#   , nrow = 2
#   , rel_widths = c(1, 0.05, 1, 1, 0.05,1 )
#   , labels = c("a", "", "b", "c", "", "d")
# )
```

old:
```{r}
# 
# # differnet multipe ploting options
# options(warn=0)
# title <- ggdraw() + draw_label("2018 Cruise: Surface Flowthrough w Station IDs")
# p<- plot_grid(m.cel, m.chl, align = "h", nrow = 1, rel_widths =  c(1, 1.0))
# p1<-plot_grid(title, p, align = "h", nrow = 2, rel_heights = c(.05, 1 ))
# 
# #dev.off()
# setwd(fig)
# pdf("2018_Cruise_Surface_Flowthrough_w_Station_IDs_p_only.pdf", width =12)
# print(p)
# dev.off()
# 
# 
# 
# # 
# # setwd(fig)
# # pdf("nat_geo_fig1_test1.pdf")
# # m.w
# # dev.off()
# 

```

## Figure 2
### Load Data 3 - Remote/Sensing
* load in lists of  aqua and terra, maybe viirs

#### aqau, terra, viirs combined
* produces combination of aqau and terra chla
* change directory by computer, improve here

```{r}

#### combining aqau terra, and viirs ####

f.tmp1<-function(x){
  y<-nc_open(x)
  chl<-ncvar_get(y, 'chlor_a')
  lon<-ncvar_get(y, 'lon')
  lat<-ncvar_get(y, 'lat')
  rownames(chl)<-lon
  colnames(chl)<-lat
  nc_close(y)
  rm(y)
  x<-chl
  return(x)
}
f.tmp2<-function(x){
  y<-nc_open(x)
  # start<-ncatt_get(y, attname = 'time_coverage_start', varid = 0, verbose=F)
  # start<-start$value
  # start<-ymd_hms(start)
  # start<-with_tz(start, tz="US/Mountain")
  
  end<-ncatt_get(y, attname = 'time_coverage_end', varid = 0, verbose=F)
  end<-end$value
  end<-ymd_hms(end)
  end<-with_tz(end, tz="US/Mountain")
  # time<-c(start, end, (end-start))
  day<-day(end)
  nc_close(y)
  # rm(y, start, end)
  rm(y, end)
  
  return(as.character(day))
  
  
  lon<-ncvar_get(y, 'lon')
  lat<-ncvar_get(y, 'lat')
  rownames(chl)<-lon
  colnames(chl)<-lat
  nc_close(y)
  rm(y)
  x<-chl
  return(x)
}
# f.tmp3<-function(a,t){
#   z<-(a+t)/2
#   return(z)}

#aqua
# aqua_directory<-"/home/brandon/vestawd/omz/ocean_color_bud/aqua"
# directory<-"C:/Users/brandon/Desktop/omz/ocean_color_bud/aqua"
# directory<-"/home/brandon/Desktop/omz/ocean_color_bud/aqua"

setwd(wd)
setwd(aqua_directory)
files<-list.files()

a<-lapply(files, f.tmp1)
dates<-lapply(files, f.tmp2)
names(a)<-as.character(dates)
rm(files, directory, dates)

#terra
# terra_directory<-"/home/brandon/vestawd/omz/ocean_color_bud/terra"
# directory<-"C:/Users/brandon/Desktop/omz/ocean_color_bud/terra"
# directory<-"/home/brandon/Desktop/omz/ocean_color_bud/terra"


setwd(wd)
setwd(terra_directory)
files<-list.files()

t<-lapply(files, f.tmp1)
dates<-lapply(files, f.tmp2)
names(t)<-as.character(dates)
rm(files, directory, dates)

lon<-as.numeric(rownames(a[[1]]))
lat<-as.numeric(colnames(a[[1]]))


#viirs

# viirs_directory<-"/home/brandon/vestawd/omz/ocean_color_bud/viirs"
# directory<-"C:/Users/brandon/Desktop/omz/ocean_color_bud/viirs"
# directory<-"/home/brandon/Desktop/omz/ocean_color_bud/viirs"

setwd(wd)
setwd(viirs_directory)
files<-list.files()

v<-lapply(files, f.tmp1)
dates<-lapply(files, f.tmp2)
names(v)<-as.character(dates)
rm(files, directory, dates)


combined<-vector(mode="list", length=length(a))
for(i in 1:length(combined)){
combined[[i]]<-(a[[i]]+t[[i]]+v[[i]])/3
  }

for(i in 1:length(combined)){
  combined[[i]]<-ifelse(is.na(combined[[i]]),(a[[i]]+t[[i]])/2,combined[[i]])
}

for(i in 1:length(combined)){
  combined[[i]]<-ifelse(is.na(combined[[i]]),(a[[i]]+v[[i]])/2,combined[[i]])
}

for(i in 1:length(combined)){
  combined[[i]]<-ifelse(is.na(combined[[i]]),(t[[i]]+v[[i]])/2,combined[[i]])
}

for(i in 1:length(combined)){
  combined[[i]]<-ifelse(is.na(combined[[i]]),a[[i]],combined[[i]])
}

for(i in 1:length(combined)){
  combined[[i]]<-ifelse(is.na(combined[[i]]),t[[i]],combined[[i]])
}

for(i in 1:length(combined)){
  combined[[i]]<-ifelse(is.na(combined[[i]]),v[[i]],combined[[i]])
}

names(combined)<-names(a)
rm(a,t,v, i)





#### cretaing spatil objects

# testing jusrt one

 # test<-combined$`16`
 
 # y<-nc_open(x)
 # 
 # 
 # test<-st_as_sf(test, coords = c(lon, lat),
 #                 crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")



```

#### unused
```{r}
#setwd(robj)
#pal<-read_rds("color_palette_figure2_grl.R")
```
#### geotiif objects 
 load list
commnetd out - make ggplot objects

* redo for new figures:
* even versu odd, can I slecte by date?
* IMPORTANT raster stack is a local directory pointer object 
```{r}

# directory<-paste(ocean_color, "/true_color/viirs", sep ="") #change to modis if nessecary 
setwd(wd)
setwd(ocean_color)
setwd("./true_color/viirs")
files<-list.files()

v_rgb<-lapply(files,stack)
#v_rgb<-lapply(v_rgb, ggRGB, r=1, g=2, b=3) 
rm(files)
```

#### save fig 2 r objects
gdal errors with v_rgb seem to be corrected by not load older robjects of v_rgb.
 
 
```{r}
setwd(robj)
saveRDS(combined, "combined_chl_fig2.R")
#saveRDS(v_rgb,"plots_rgb_fig2.R")
saveRDS(v_rgb,"viirs_rgb.R")

```

#### load fig 2 r objects

```{r}
setwd(robj)
combined<-readRDS("combined_chl_fig2.R")
#v_rgb<-readRDS("plots_rgb_fig2.R")
# v_rgb<-readRDS("viirs_rgb.R")
stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")
st3.5<-stations_positions_list[[3]][4,cbind(2,3)]
rm(stations_positions_list)


```
### ploting 

#### Final Attempt (5.b) - individual plots 
* add 200 km circle- 100km radi
https://stackoverflow.com/questions/34183049/plot-circle-with-a-certain-radius-around-point-on-a-map-in-ggplot2

```{r}
setwd(wd)
setwd(robj)


stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")
st3.5<-stations_positions_list[[3]][4,cbind(2,3)]
rm(stations_positions_list)

st3.5<-sf::st_as_sf(st3.5, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st3.5, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") 
rm(flat, st3.5)


```
 main figure
```{r}
start<-Sys.time()

options(warn=-1)
plots<-vector(mode='list', length = length(combined))

cuts<-c(0, 0.01, 0.02, 0.04,  0.08,  0.1,  0.15, 0.2, 0.35, 0.5, 0.8, 0.9, 1, 2,3,4, 5)
n<-length(cuts)+1
custom_color<-rev(rainbow(n))
cuts<-rescale(cuts)
title_two<-expression(atop(textstyle("Chl a"), textstyle("mg m"^-3*"")))
labs<-c(0.1, .5, 1, 2 , 2.5, 5)

# bar_height<-25

bar_height<-22.70

f.fig2<-function(combined, v_rgb, i, t, l){
  t1<-combined[[i]]
  t2<-v_rgb[[i]]
  date<-paste0("June", " ", names(combined)[i])
  
  lat<-as.numeric(row.names(t(t1)))
  lon<-as.numeric(colnames(t(t1)))
  
  t1<-raster(t(t1))

  extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
  t1_ex<-extent(t1)
  t2_ex<-extent(t2)
  extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  rm(t1_ex, t2_ex)
  
  
  t3<-resample(t1, t2)
  t3<-na.omit(t3)
  rm(t1)
  
  f1<- ggRGB(t2, r=1, g=2, b=3, ggObj = T) + ggtitle(date)+theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          #panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_y_continuous(expand = c(0, 0))+
    scale_x_continuous(expand = c(0, 0), breaks=seq(-120, -100, b=10))
    
  
  f3<-f1+ggR(t3, geom_raster = TRUE, ggLayer=T) +
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
                         name=waiver(),breaks=labs)+
    guides(fill=guide_colourbar(title=bquote(title_two), barheight = 8)) +
    theme(legend.title =element_text(size=8), legend.text=element_text(size=6)) + 
    theme(text=element_text(family="Helvetica")) + theme(legend.position = "none") +
    geom_sf(data = circle, color = "red", alpha = 0, inherit.aes = FALSE) 
  
  return(f3)
}
f.fig2_no_y<-function(combined, v_rgb, i, t, l){
  t1<-combined[[i]]
  t2<-v_rgb[[i]]
  date<-paste0("June", " ", names(combined)[i])
  
  lat<-as.numeric(row.names(t(t1)))
  lon<-as.numeric(colnames(t(t1)))
  
  t1<-raster(t(t1))
  extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
  t1_ex<-extent(t1)
  t2_ex<-extent(t2)
  extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  rm(t1_ex, t2_ex)
  
  
  t3<-resample(t1, t2)
  t3<-na.omit(t3)
  rm(t1)
  
  f1<- ggRGB(t2, r=1, g=2, b=3, ggObj = T) + ggtitle(date)+theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          #panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0, 0), breaks=seq(-120, -100, b=10))
  
  f3<-f1+ggR(t3, geom_raster = TRUE, ggLayer=T) +
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
                         name=waiver(),breaks=labs)+
    guides(fill=guide_colourbar(title=bquote(title_two), barheight = 8)) +
    theme(legend.title =element_text(size=8), legend.text=element_text(size=6)) + 
    theme(text=element_text(family="Helvetica")) + theme(legend.position = "none") +
    theme(axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
    geom_sf(data = circle, color = "red", alpha = 0, inherit.aes = FALSE) 
   
        
  
  
  return(f3)
}
f.fig2_legend<-function(combined, v_rgb, height, width, t,b,r,l, title.textsize, marks.textsize){
  t1<-combined[[1]]
  t2<-v_rgb[[1]]
  
  lat<-as.numeric(row.names(t(t1)))
  lon<-as.numeric(colnames(t(t1)))
  
  t1<-raster(t(t1))
  extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
  t1_ex<-extent(t1)
  t2_ex<-extent(t2)
  extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  rm(t1_ex, t2_ex)
  
  
  t3<-resample(t1, t2)
  t3<-na.omit(t3)
  rm(t1)

  
  p<-ggplot()+ggR(t3, geom_raster = TRUE, ggLayer=T) +
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(0, 0, 0, 0, 0), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
                         name=waiver(),breaks=labs)+
    guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width)) +
    theme(legend.title =element_text(size=title.textsize), legend.text=element_text(size=marks.textsize)) + 
    theme(text=element_text(family="Helvetica"))
  
  legend <- get_legend(p + theme(legend.box.margin = margin(t, r, b, l)))
  rm(p, t3, t2) 
  return(legend)
} # l = legend margin left, b=barhieght (in cm ) of legend

#indovidually assin plots

i<-1
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-4
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-7
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-10
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-2
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-3
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-5
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-6
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-8
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-9
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-11
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-12
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)


p<-(plots[[1]]+ plots[[2]]+plots[[3]]+plots[[4]]+plots[[5]]+ plots[[6]]+ plots[[7]]+ plots[[8]]+plots[[9]]+plots[[10]]+ plots[[11]]+plots[[12]]+plot_layout(ncol=3))

legend<-f.fig2_legend(combined, v_rgb, height=bar_height, width=1, t=-390, b=0, r=0, l=-115,  title.textsize=10, marks.textsize=8)

### various legend options unused: ####

# b=.5
# height=45
# title.textsize=14, marks.textsize=12)
# r=30
# width=1.75
#  rel_widths=c(28,1)

# 
# setwd(fig)
# pdf("figure_two_legend_right_Top_axis_V6.pdf", height=11 , width =8.5)
# plot_grid(p, legend.t, ncol=2, rel_widths=c(42,1),  axis="b")
# dev.off()
# 
# 
# legend.b<-f.fig2_legend(combined, v_rgb, height=25, width=1, t=0, b=-362, r=0, l=-100,  title.textsize=10, marks.textsize=8)
# 
# setwd(fig)
# pdf("figure_two_legend_right_Bottom_axis.pdf", height=11 , width =8.5)
# plot_grid(p, legend.b, ncol=2, rel_widths=c(42,1),  axis="b")
# dev.off()
# 
# 
# legend.c<-f.fig2_legend(combined, v_rgb, height=25, width=1, t=0, b=.5, r=0, l=-100,  title.textsize=10, marks.textsize=8)
# 
# 
# setwd(fig)
# pdf("figure_two_legend_right_Centered_axis.pdf", height=11 , width =8.5)
# plot_grid(p, legend.c, ncol=2, rel_widths=c(42,1),  axis="b")
# dev.off()
# 

### finsiheed ####
rm(combined, v_rgb)

end<-Sys.time()
elapsed<-end-start
print(elapsed)

```

##### Horizontal legend
 not used
```{r}
# f.fig2_legend_h<-function(combined, v_rgb, height, width, t,b,r,l, title.textsize, marks.textsize){
#   t1<-combined[[1]]
#   t2<-v_rgb[[1]]
#   
#   lat<-as.numeric(row.names(t(t1)))
#   lon<-as.numeric(colnames(t(t1)))
#   
#   t1<-raster(t(t1))
#   extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
#   t1_ex<-extent(t1)
#   t2_ex<-extent(t2)
#   extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
#   extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
#   rm(t1_ex, t2_ex)
#   
#   
#   t3<-resample(t1, t2)
#   t3<-na.omit(t3)
#   rm(t1)
# 
#   
#   p<-ggplot()+ggR(t3, geom_raster = TRUE, ggLayer=T) +
#     theme(axis.line = element_line(colour = "black"),
#           plot.margin = unit(c(0, 0, 0, 0, 0), "cm"),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_rect(colour = "black", fill=NA, size=5),
#           axis.title.x=element_blank(),
#           axis.title.y=element_blank()) +
#     scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
#                          name=waiver(),breaks=labs)+
#     guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width)) +
#     theme(legend.title =element_text(size=title.textsize), legend.text=element_text(size=marks.textsize)) + 
#     theme(text=element_text(family="Helvetica"))+ theme(legend.position="bottom")
#   
#   legend <- get_legend(p + theme(legend.box.margin = margin(t, r, b, l)))
#   rm(p, t3, t2) 
#   return(legend)
# } # l = legend margin left, b=barhieght (in cm ) of legend
# legend.bb<-f.fig2_legend_h(combined, v_rgb, height=1, width=26, t=0, b=-5, r=0, l=0,  title.textsize=10, marks.textsize=8)
# 
# 
# 
# setwd(fig)
# pdf("figure_two_legend_Bottom.pdf", height=11 , width =8.5)
# plot_grid(p, legend.bb, nrow=2, rel_heights =c(20,1))
# dev.off()
```



#### resubmission - individual plots 
* even dates -> main figure
* odd

```{r}
setwd(robj)

stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")
st3.5<-stations_positions_list[[3]][4,cbind(2,3)]
rm(stations_positions_list)

st3.5<-sf::st_as_sf(st3.5, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st3.5, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") 
rm(flat, st3.5)


```
 main figure
```{r}
start<-Sys.time()

options(warn=-1)
plots<-vector(mode='list', length = length(combined))

cuts<-c(0, 0.01, 0.02, 0.04,  0.08,  0.1,  0.15, 0.2, 0.35, 0.5, 0.8, 0.9, 1, 2,3,4, 5)
n<-length(cuts)+1
custom_color<-rev(rainbow(n))
cuts<-rescale(cuts)
title_two<-expression(atop(textstyle("Chl a"), textstyle("mg m"^-3*"")))
labs<-c(0.1, .5, 1, 2 , 2.5, 5)

# bar_height<-25

bar_height<-22.70

f.fig2<-function(combined, v_rgb, i, t, l){
  t1<-combined[[i]]
  t2<-v_rgb[[i]]
  date<-paste0("June", " ", names(combined)[i])
  
  lat<-as.numeric(row.names(t(t1)))
  lon<-as.numeric(colnames(t(t1)))
  
  t1<-raster(t(t1))

  extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
  t1_ex<-extent(t1)
  t2_ex<-extent(t2)
  extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  rm(t1_ex, t2_ex)
  
  
  t3<-resample(t1, t2)
  t3<-na.omit(t3)
  rm(t1)
  
  f1<- ggRGB(t2, r=1, g=2, b=3, ggObj = T) + ggtitle(date)+theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          #panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_y_continuous(expand = c(0, 0))+
    scale_x_continuous(expand = c(0, 0), breaks=seq(-120, -100, b=10))
    
  
  f3<-f1+ggR(t3, geom_raster = TRUE, ggLayer=T) +
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
                         name=waiver(),breaks=labs)+
    guides(fill=guide_colourbar(title=bquote(title_two), barheight = 8)) +
    theme(legend.title =element_text(size=8), legend.text=element_text(size=6)) + 
    theme(text=element_text(family="Helvetica")) + theme(legend.position = "none") +
    geom_sf(data = circle, color = "red", alpha = 0, inherit.aes = FALSE) 
  
  return(f3)
}
f.fig2_no_y<-function(combined, v_rgb, i, t, l){
  t1<-combined[[i]]
  t2<-v_rgb[[i]]
  date<-paste0("June", " ", names(combined)[i])
  
  lat<-as.numeric(row.names(t(t1)))
  lon<-as.numeric(colnames(t(t1)))
  
  t1<-raster(t(t1))
  extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
  t1_ex<-extent(t1)
  t2_ex<-extent(t2)
  extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  rm(t1_ex, t2_ex)
  
  
  t3<-resample(t1, t2)
  t3<-na.omit(t3)
  rm(t1)
  
  f1<- ggRGB(t2, r=1, g=2, b=3, ggObj = T) + ggtitle(date)+theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          #panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0, 0), breaks=seq(-120, -100, b=10))
  
  f3<-f1+ggR(t3, geom_raster = TRUE, ggLayer=T) +
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(t, 0, 0, l), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
                         name=waiver(),breaks=labs)+
    guides(fill=guide_colourbar(title=bquote(title_two), barheight = 8)) +
    theme(legend.title =element_text(size=8), legend.text=element_text(size=6)) + 
    theme(text=element_text(family="Helvetica")) + theme(legend.position = "none") +
    theme(axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
    geom_sf(data = circle, color = "red", alpha = 0, inherit.aes = FALSE) 
   
        
  
  
  return(f3)
}
f.fig2_legend<-function(combined, v_rgb, height, width, t,b,r,l, title.textsize, marks.textsize){
  t1<-combined[[1]]
  t2<-v_rgb[[1]]
  
  lat<-as.numeric(row.names(t(t1)))
  lon<-as.numeric(colnames(t(t1)))
  
  t1<-raster(t(t1))
  extent(t1)<-extent(min(lon), max(lon), min(lat), max(lat))
  t1_ex<-extent(t1)
  t2_ex<-extent(t2)
  extent(t1)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  extent(t2)<-extent(t1_ex[1], t2_ex[2], t2_ex[3], t2_ex[4])
  rm(t1_ex, t2_ex)
  
  
  t3<-resample(t1, t2)
  t3<-na.omit(t3)
  rm(t1)

  
  p<-ggplot()+ggR(t3, geom_raster = TRUE, ggLayer=T) +
    theme(axis.line = element_line(colour = "black"),
          plot.margin = unit(c(0, 0, 0, 0, 0), "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect(colour = "black", fill=NA, size=5),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    scale_fill_gradientn(colors = custom_color, values=cuts, na.value=NA,limits=c(0,5), 
                         name=waiver(),breaks=labs)+
    guides(fill=guide_colourbar(title=title_two, barheight = height, barwidth = width)) +
    theme(legend.title =element_text(size=title.textsize), legend.text=element_text(size=marks.textsize)) + 
    theme(text=element_text(family="Helvetica"))
  
  legend <- get_legend(p + theme(legend.box.margin = margin(t, r, b, l)))
  rm(p, t3, t2) 
  return(legend)
} # l = legend margin left, b=barhieght (in cm ) of legend

#indovidually assin plots

i<-1
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-4
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-7
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-10
plots[[i]]<-f.fig2(combined, v_rgb, i=i, t=0, l=0)
i<-2
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-3
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-5
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-6
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-8
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-9
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-11
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)
i<-12
plots[[i]]<-f.fig2_no_y(combined, v_rgb, i=i, t=0, l=0)


p<-(plots[[1]]+ plots[[2]]+plots[[3]]+plots[[4]]+plots[[5]]+ plots[[6]]+ plots[[7]]+ plots[[8]]+plots[[9]]+plots[[10]]+ plots[[11]]+plots[[12]]+plot_layout(ncol=3))

legend<-f.fig2_legend(combined, v_rgb, height=bar_height, width=1, t=-390, b=0, r=0, l=-115,  title.textsize=10, marks.textsize=8)


### finsiheed ####
rm(combined, v_rgb)

end<-Sys.time()
elapsed<-end-start
print(elapsed)

```




#### - saving figure 2 and tertiary margins

```{r}

setwd(fig)
pdf("figure_two.pdf", height=11 , width =8.5)
plot_grid(p, legend, ncol=2, rel_widths=c(14,1), align="h")
dev.off()

```

## Figure 3

## CTD Panels
*Temp/FL/DO
*Stations 2 -4
## Figure 4



# Supplemamntary figures
## S1 Time sereis plot: chrophhyll, celsius
main
fix chlorphy label on second y axis
```{r}
setwd(fig)
# options(device ="X11")# for viewing graphs on large window

###plot options ##
# best thing is tho calculate hour average from raw data

x<-cruise_data # to make typing easier 

# x$wind<-x$wind*0.514444 # knots ->m/s
# x = x[seq(1, nrow(x), 15), ] # subset every 15 minutes for cleaner image
# x = x[seq(1, nrow(x), 30), ] #
#x = x[seq(1, nrow(x), 60), ] # subset every 60 minutes

mydates <- interval(start = min(x$time), end = "2018-06-25") # subset x-axis
x<- x[which(time %within% mydates),]
rm(mydates)

scale.wind<-max(x$celsius) / max(x$wind)
scale.chla<-max(x$celsius) / max(x$chlorophyll)

rect_color<-"grey89"
tcolor<-"red"
fcolor<-"darkgreen"
#wcolor<-"cyan"

#### f1 rectangles #####
# adjust geom etx for various plots

# change the geom text value to change position of lables

# high for wind:
# geom_text(data=rects, x=centered, label=rects[,2], y =32.5, angle =90) +

# centered for clophyll 
# geom_text(data=rects, x=centered, label=rects[,2], y =16.5, angle =90) +


# 3.5 for wind plot


f1 <- ggplot(x, aes(x = time)) + geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_text(data=rects, x=centered, label=rects[,2], y =34, angle =0) +
  theme_bw()


#### f3 temp & chl-a ####
f3<-f1 +
  geom_line(aes(y=chlorophyll * scale.chla), color=fcolor) +
  geom_line(aes(y=celsius), color=tcolor) +
  xlab("Date") +
  ggtitle("SST and Chlorophyll-a") +
  scale_x_datetime(date_breaks=('2 days'))+
  scale_y_continuous(name ="SST (°C)", sec.axis = sec_axis(~./scale.chla,name="Chlorophyll-a [μg/L]"))+
  #scale_y_continuous(name ="Chlorophyll-a [μg/L]", sec.axis = sec_axis(~./scale.chla,name="°C")) + 
  theme(
    panel.background = element_rect(fill = NA),
    panel.ontop = FALSE
  ) + 
  scale_x_datetime(date_labels = "%m/%d", date_breaks="2 days", date_minor_breaks = "1 days") +
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.ticks.y.left = element_line(color = tcolor),
        axis.text.y.left = element_text(color = tcolor), 
        axis.title.y.left = element_text(color = tcolor)
  ) +
  
  theme(axis.ticks.y.right = element_line(color = fcolor),
        axis.text.y.right = element_text(color = fcolor), 
        axis.title.y.right = element_text(color = fcolor)
  )+

  theme(
    panel.background = element_rect(fill = NA),
    panel.ontop = FALSE
  )



# add panel text




```

 with wind (not used)
```{r}
# ##### Wind ##### 
# f.read<-function(fdata){
#   
#   files<-list.files(fdata)
#   data<-vector(mode="list", length=length(files))
#   
#   for(i in 1:length(files)){
#     data[[i]]<-read.delim(file.path(fdata, files[i]), sep =",", header = F)  
#   }
#   
#   return(data)}
# 
# f.rearrange<-function(x){
#   
#   #names(x)<-c.names
#   options("digits.secs"=3)
#   x$time<-mdy_hms(paste(x$V1, x$V2, tz="UTC"))
#   x$time<-with_tz(x$time, tz="US/Mountain")
#   x$date<-date(x$time)
#   #x<-subset(x, select=c(date, time, V3, V4, V5, V6, V7,V8,V9,V10))
#   x<-subset(x, select=c(date, time, V5))
#   x<-as_tibble(x)
#   return(x)
# }
# 
# 
# setwd(wdata)
# data<-f.read(fdata)
# 
# raw<-lapply(data, f.rearrange)
# rm(data, f.read, f.rearrange)
# 
# x<-do.call(rbind.data.frame, raw)
# rm(raw)
# x$V4<-as.numeric(x$V4)
# x$V5<-as.numeric(x$V5)
# x$V8<-as.numeric(x$V8)
# 
# # remove 999.9
# 
# x[x == 999.99] <- NA
# 
# 
# 
# setwd(robj)
# names(x)
# saveRDS(x, "2018_wind_raw.R")
# 
# 
# 
# ### graphing 
# 
# wcolor<-"skyblue4"
# 
# 
# 
# 
# 
# 
# f1<-ggplot(x, aes(x=time)) +
#   geom_line(aes(y=V5), color="blue") +
#   geom_line(aes(y=V8), color="green") +
#   xlab("Date") +
#   ggtitle("2018 Anemometer") +
#   scale_x_datetime(date_breaks=('2 days'))+
#   scale_y_continuous(name ="V5", sec.axis = sec_axis(~.,name="V8")) + 
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
#   theme(plot.title = element_text(hjust = 0.5))+
#   theme(axis.ticks.y.left = element_line(color = "blue"),
#         axis.text.y.left = element_text(color = "blue"), 
#         axis.title.y.left = element_text(color = "blue")
#   ) +
#   
#   theme(axis.ticks.y.right = element_line(color = "green"),
#         axis.text.y.right = element_text(color = "green"), 
#         axis.title.y.right = element_text(color = "green")
#   )
# 
# #### f2 wind & temp ####
# f2<-f1 +
#   geom_line(aes(y=wind * scale.wind), color=wcolor) +
#   geom_line(aes(y=celsius), color=tcolor) +
#   xlab("Date") +
#   ggtitle("SST and Wind Speed") +
#   scale_x_datetime(date_breaks=('2 days'))+
#   scale_y_continuous(name ="SST (°C)", sec.axis = sec_axis(~./scale.wind ,name="Wind Speed (m/s)"))+
#   theme(
#     panel.background = element_rect(fill = NA),
#     panel.ontop = FALSE
#   ) + 
#   scale_x_datetime(date_labels = "%m/%d", date_breaks="2 days", date_minor_breaks = "1 days") +
#   theme(plot.title = element_text(hjust = 0.5))+
#   theme(axis.ticks.y.left = element_line(color = tcolor),
#         axis.text.y.left = element_text(color = tcolor), 
#         axis.title.y.left = element_text(color = tcolor)
#   ) +
#   
#   theme(axis.ticks.y.right = element_line(color = wcolor),
#         axis.text.y.right = element_text(color = wcolor), 
#         axis.title.y.right = element_text(color = wcolor)
#   )+
# 
#   theme(
#     panel.background = element_rect(fill = NA),
#     panel.ontop = FALSE
#   )
# 

```

### save s1 fig

### pdf

```{r}

setwd(fig)
pdf("figure_s1_test.pdf", width =10)
print(f3)
dev.off()
```

### EPS
```{r}
##### saving figures #####

setwd(fig)
cairo_ps("S1_flowthorugh_time_sereis_plot.eps", width=8, height=5)
print(f2)
dev.off()
dev.off()
#quit("no")

```


# random things
## kml of stations

```{r}
# setwd(wd)
# names(stations_mapped)<-c("Name", "Description", "geometry")
# st_write(stations_mapped, "OC1806A_stations.kml", driver="kml")


```

