---
title: "ch1_appendix"
author: "Brandon M. Genco"
date: "`r Sys.Date()`"
output: html_document
---

In order of
1)ADCP
2)CTD casts
3) extra export figs
-signal and noise
-pdo and enso


# setup
```{r setup}
rm(list=ls())

r_scriptwd<-getwd()
wd<-substring(r_scriptwd,1,nchar(r_scriptwd) -10) # hardcoding replace here
knitr::opts_knit$set(root.dir = wd)


# relative directories
robj<-"r_objects"
fig<-"../../figures"
gis_data<-"../../data/gis_data"
output<-"../../output"


knitr::opts_chunk$set(echo =FALSE, warning = FALSE)
#knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) #deleated local rproj file. giut hub issues
```

## packages and working directory

Installed custom hurdat package using r markdown menu
* download  tar from archive as no longer maintained on cran repository
* https://cran.r-project.org/src/contrib/Archive/HURDAT/
+ include as git submodule instead

```{r}
# wd<-getwd()

f.ipak <- function(pkg){
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}

# packages<-c("stars", "gridExtra", "cowplot", "sf", "ggspatial","stringr","sp", "rgdal",  "rgeos", "raster","readr" ,"tidyverse", "ggplot2", "lubridate",  "ggthemes", "data.table", "reshape2", "RColorBrewer", "marmap", "extrafont", "oce", "MODIS", "measurements")  # set packages here
# tidyverse: is all of the following packages: ggplot2, dplyr, tidyr, readr, purr, tibble, sringr, & forcats.

# remotes::install_github("R-Finance/xtsExtra")

packages<-c("sp", "rgdal",  "rgeos", "raster", "readr", "tidyverse", "lubridate",  "ggthemes",  "sf", "cmocean", "ncdf4", "RNetCDF",  "plot3D", "tidync", "devtools", "stars", "ncmeta", "maps", "oce", "data.table", "fasterize", "RStoolbox", "scales", "purrr", "HURDAT", "ggpattern", "zoo", "xts", "dsa",  "tsibble", "feasts", "tsbox", "rsoi", "cowplot")

# "HURDAT",
# "cowplot.pa")


f.ipak(packages)
# lapply(packages, require, character.only = TRUE)
# rm(f.ipak, packages)
print(paste0("Current Working Directory is ", getwd()))

```


## Functions

```{r}
f.anomaly<-function(c){
  m<-mean(c)
  n<-c-m
  return(n)
}

f.noise<-function(x, h.date, prior, post){

x<-x1
noise<-vector(mode='list', length=(length(h.date)))
# y<-na.omit(x1)

for(i in 1:length(h.date)){
noise[[i]]<-filter(x, between(x$date, (h.date[i]-prior), (h.date[i]+post)))
}

noise<-Filter(Negate(is.null), noise)
noise<-bind_rows(noise)
noise<-filter(noise, duplicated(noise$date)==F)

signal<-x[!x$date %in% noise$date,]
# signal<-filter(x, date!=noise$date)
split<-list(signal, noise)
names(split)<-c("signal", "noise")
return(split)}
```

# adcp
# ctd casts
```{r}
print(getwd())
```

```{r}

d.sec<-readRDS("r_objects/OC1806A_ctd_sections.R")
d35<-d.sec$st3.5

c1<-d35@data$station[[1]]

c2<-d35@data$station[[2]]
c3<-d35@data$station[[3]]
c4<-d35@data$station[[4]]
c5<-d35@data$station[[5]]

times<-c(c1@metadata$date, c2@metadata$date, c3@metadata$date, c4@metadata$date, c5@metadata$date) 
times<-ymd_hms(times)%>%with_tz(., tzone="US/Mountain")%>%round_date(., 'minute')%>% as.character(.) %>%as.POSIXct(.)      
times<-format(times, format="%m-%d %H:%M")

# d35@metadata$time<-times

d4<-d.sec$st4



```


```{r}
# need to use local time on these objects. will need to photohsop times


plot(d35, which="oxygen2", ztype="image", xtype="time", ylim=c(-20,80), xlab=NULL)
plot(d35, which=3, ztype="image", xtype="time", ylim=c(-20,80)) # density
plot(d35, which=c("oxygen2", "density"), ztype="point", xtype="time", ylim=c(-20,70)) # density

plot(d35, which=c("oxygen2", "beamAttenuation", "density"), ztype="image", xtype="time", ylim=c(-20,70)) # density

plot(d35, which="fluorescence", ztype="image", xtype="time", ylim=c(-20,80))
plot(d35, which="par", ztype="image", xtype="time", ylim=c(-20,70)) #not neede
plot(d35, which="par", ztype="points", xtype="time", ylim=c(-20,70)) #not neede

```


```{r}
plot(d4, which="oxygen2", ztype="image", xtype="time", ylim=c(-20,80), xlab=NULL)
plot(d4, which=3, ztype="image", xtype="time", ylim=c(-20,80)) # density

plot(d4, which="fluorescence", ztype="image", xtype="time", ylim=c(-20,80))
plot(d4, which="par", ztype="image", xtype="time", ylim=c(-20,80)) #not neede

st_4times<-ymd_hms(d4@metadata$time)%>%with_tz(., tzone="US/Mountain")%>%round_date(., 'minute')%>% as.character(.) %>%as.POSIXct(.) 

```{r}




```



```{r}
plot(d35, drawIsobaths=T, which="map")
plot(d35, which=3, ztype="image", xtype="time")
plot(d35, which="salinity", ztype="image", xtype="time")
plot(d35, which="temperature", ztype="image", xtype="time")
plot(d35, which="oxygen2", ztype="image", xtype="time")
plot(d35, which="fluorescence", ztype="image", xtype="time")

```

## individual plots


corelation
```{r}

```

c2
```{r}
plot(c2, which=c("oxygen2", 6), type="l"m yl)
plot(c2, which=c("oxygen2", 2), type="l")
plot(c2, which=c("oxygen2", 6, "temperature", "beamAttenuation"), type="l", zlim)

```


## stats
```{r}
cor(c2@data$oxygen2, c2@data$beamAttenuation)
```

# export flux
### export flux load data
#### load hurricanes
## load basic hurdat

```{r}
setwd(wd)
setwd(robj)
#<-get_hurdat(basin="EP")
#saveRDS(h, "hurdat.R")
h<-readRDS("hurdat.R")
h$DateTime<-force_tz(h$DateTime, tz="UTC")

```

#### load POC

```{r}
setwd(wd)
setwd(robj)

data<-read_rds("vgpm_integrated_all_years_202200607.R")
x<-data$st3.5
rm(data)

window_area<-round((x$`window_area (m^2)`[1]*1e-6),0)
lab_total<-paste0("Station ", "3.5", ":", " Total Export Flux - ", window_area, " km^2 area")

x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

sst<-readRDS("st35_sst_modis.R")
z<-select(sst, date, `SST_mean (area weighted)`)
rm(sst)
names(z)<-c("date", "sst")
z$date<-ymd(z$date)

chl<-readRDS("st35_chl_modis.R")
y<-select(chl, date, 'chl_mean (area weighted)')
rm(chl)
names(y)<-c("date", "chl")
y$date<-ymd(y$date)

```


## Signal and noise

## PDO & Enso

