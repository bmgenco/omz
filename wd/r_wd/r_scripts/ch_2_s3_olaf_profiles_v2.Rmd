---
title: "olaf_profiles v2"
author: "Brandon M. Genco"
date: "7/5/2022"
output: html_document
---
# Setup
## Directories and defaults
Use r proj file for relative directories
see: https://yihui.org/knitr/options/

from mike:

" Float 6903093, which we had included data from near Station 3.5, and it turns out it had almost the perfect hurricane encounter last year.  On cycle 49 it came up almost right underneath Hurricane Olaf.  4 days later it came up nearby and the OMZ definitely shoaled (cycle 50).  Cycle 51 was also close by, and looks like the OMZ was back at its original depth.  Then the float really starts moving and ends up pretty far away.  Definitely check it out, and I think a supporting figure with a map of the hurricane track + position of those three profiles, and then another panel with the DO profiles, would be really interesting to include!”




```{r setup}
rm(list=ls())
r_scriptwd<-getwd()
wd<-substring(r_scriptwd,1,nchar(r_scriptwd) -10) # hardcoding replace here
knitr::opts_knit$set(root.dir = wd)

# relative directories
robj<-"r_objects"
fig<-"../../figures"
gis_data<-"../../data/gis_data"
data_d<-"../../data/2018_data"
# data_d<-"../../data"
ocean_color<-"../../data/ocean_color_bud"
bathy_d<-"../../data/bathy" # edit this

#absolute directory
drop_img<-"/home/brandon/Dropbox/MERCED/dissertation/presentations/images"

knitr::opts_chunk$set(echo =FALSE)
knitr::purl("ch_2_s3_olaf_profiles_v2.Rmd")
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Packages

Installed custom hurdat package using r markdown
## ploting and coastal subsetting objects  menu
* download  tar from archive as no longer maintained on cran repository
* https://cran.r-project.org/src/contrib/Archive/HURDAT/
+ include as git submodule instead

```{r}
f.ipak <- function(pkg){
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}

packages<-c("sp", "rgdal",  "rgeos", "raster", "readr", "tidyverse", "lubridate",  "ggthemes",  "sf", "cmocean", "ncdf4", "RNetCDF",  "plot3D", "tidync", "devtools", "stars", "ncmeta", "maps", "oce","data.table","raster", "fasterize", "RStoolbox", "scales", "purrr", "marmap", "cowplot", "gsw")

f.ipak(packages)
# lapply(packages, require, character.only = TRUE)
# rm(f.ipak, packages)
print(paste0("Current Working Directory is ", getwd()))

wd<-getwd()
```

## Load submodules newer

```{r}
# main functions
path<-"r_scripts/submodules/OneArgo-R/"

source(paste0(path, "get_lon_lat_time.R"))
source(paste0(path, "initialize_argo.R"))
source(paste0(path, "load_float_data.R"))
source(paste0(path, "select_profiles.R"))
source(paste0(path, "show_profiles.R"))
source(paste0(path, "show_sections.R"))
source(paste0(path, "show_time_series.R"))
source(paste0(path, "show_trajectories.R"))

# auxilary functions
path = "r_scripts/submodules/OneArgo-R/auxil/"
file_path<-paste0(wd,"/",path)
files<-list.files(file_path, pattern ="\\.R$")

for(i in 1:length(files)){
  source(paste0(path, files[i]))
}

# packages<-c("gsw", "R.utils","Matrix")
# f.ipak(packages)
# 
rm(path, file_path, files)

```

## Functions

```{r}

#### function to create buffer around hurricane points ####
f.cl_buffer<-function(function_variables, cl){
  if(is.na(function_variables$land_buffer)==TRUE){
                      function_variables$land_buffer<-100000}
  y<-st_geometry(cl)
  y<-st_union(y, is_coverage = T)
  z<-st_centroid(y)
  land_buffer<-function_variables$land_buffer
  
  lat0<-z[[1]][2]
  lon0<-z[[1]][1]
  center.reproj<-paste0("+proj=aeqd +lat_0=", lat0, " ", "+lon_0=", lon0)
  flat<-sf::st_transform(y, center.reproj )
  buffered_land<-sf::st_buffer(flat, dist=land_buffer)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") 
  return(buffered_land)
  }
## match up functions



f.select_tc<-function(x, key_id){
x<-x$tc
x<-x[which(names(x) == key_id)]
return(x)
}

### from script 'aargo_float_OLAF.profile

```


# Important objects and data sets

## data

```{r}
data<-readRDS("r_objects/ch2_seq_1_data.R")

function_variables<-data$function_variables
# hurdat objects
h<-data$selected_zone_hurdat$h
h.pts<-data$selected_zone_hurdat$h.pts
h.tracks<-data$selected_zone_hurdat$h.tracks

# match_up

list.100<-data$tc_search_radi_profiles$km_100
list.200<-data$tc_search_radi_profiles$km_200
list.500<-data$tc_search_radi_profiles$km_500

# temp for memory space
# rm(data)

```


## natural earth coastlines
source : https://www.naturalearthdata.com/downloads/10m-physical-vectors/10m-coastline/
version: 4.1.0
```{r}
setwd(gis_data)
# save shape files in named directory
coastline<-st_read("./ne_50m_land/ne_50m_land.shp") 

```

## Import BioArgo metadata (requires submodule install):

```{r}

# setwd(wd)
# setwd(robj)
# load("init_argo.RData")
```


## olaf
need to change h.pts

```{r}
key_id<-"EP152021"

tc.pts<-filter(h.pts, Key ==key_id )

conv<-1.94384 # convert to m/s
tc.pts$max_sustained_wind_m_s<-tc.pts$Wind/conv

tc.p<-f.select_tc(x=list.500, key_id)

```

per float trying..
```{r}
x<-tc.p$EP152021 %>% filter(. , float == "6903093")
```

```{r}

float.x<-as.numeric(x$float[1])
# show_sections(float_ids = float.x, float_profs = x$profile )

show_time_series(float_ids = unique(x$float))

```

```{r}
knitr::purl("ch_2_s3_olaf_profiles_v2.Rmd")
```




