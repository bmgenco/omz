---
title: "poc_flux_and_TC_and_CHl_and_SST"
author: "Brandon M. Genco"
date: "06/15/2022"
output: html_document
---
code repurposed from "Hurricane 0instu_matchup_2.rmd"

# Setup
## Directories and defaults
Use r proj file for relative directories
see: https://yihui.org/knitr/options/


```{r setup}
rm(list=ls())
# relative directories
robj<-"r_objects"
fig<-"../../figures"
gis_data<-"../../data/gis_data"
output<-"../../output"

sst_data<-"../../data/POC_Flux_data_sets/annual_vgpm_modis_sst_netcdf"
chl_data<-"../../data/POC_Flux_data_sets/annual_vgpm_modis_chl_netcdf"
 
#absolute directory
# drop_img<-"/home/brandon/Dropbox/MERCED/dissertation/presentations/images"

knitr::opts_chunk$set(echo =FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

## packages and work direcorty

Installed custom hurdat package using r markdown menu
* download  tar from archive as no longer maintained on cran repository
* https://cran.r-project.org/src/contrib/Archive/HURDAT/
+ include as git submodule instead

```{r}
wd<-getwd()

f.ipak <- function(pkg){
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}



# packages<-c("stars", "gridExtra", "cowplot", "sf", "ggspatial","stringr","sp", "rgdal",  "rgeos", "raster","readr" ,"tidyverse", "ggplot2", "lubridate",  "ggthemes", "data.table", "reshape2", "RColorBrewer", "marmap", "extrafont", "oce", "MODIS", "measurements")  # set packages here

# tidyverse: is all of the following packages: ggplot2, dplyr, tidyr, readr, purr, tibble, sringr, & forcats.

packages<-c("sp", "rgdal",  "rgeos", "raster", "readr", "tidyverse", "lubridate",  "ggthemes",  "sf", "cmocean", "ncdf4", "RNetCDF",  "plot3D", "tidync", "devtools", "stars", "ncmeta", "maps", "oce", "data.table", "fasterize", "RStoolbox", "scales", "purrr", "HURDAT", "")

# "HURDAT",

f.ipak(packages)
# lapply(packages, require, character.only = TRUE)
# rm(f.ipak, packages)
print(paste0("Current Working Directory is ", getwd()))

```

## functions

```{r}
f.grid_square_area2<-function(x) {
  x.area<-vector(mode="numeric", length = nrow(x)) 
  
  for(i in 1:length(x.area)){
    bbox<-st_bbox(x[[2]][[i]])
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    x.area[i]<- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                               proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,) %>% round(., -1)
  }
  sum_grid_area<-sum(x.area)
  x$value<-x.area
  y<-vector(mode = "list", length=2)
  names(y)<-c("grid_area", "sum_grid_area")
  y$grid_area<-x
  y$sum_grid_area<-sum_grid_area
  
  return(y)}

f.sst_data_nc<-function(z){
  
  sst_integrated<-as.data.frame(matrix(ncol = 7, nrow =length(files)))
  names(sst_integrated)<-c("date",  "SST_mean (area weighted)", "SST_mean (basic)", "SST_median", "SST_variance", "window_area (m^2)", "sum_grid_area (m^2)")
  
  for(i in 1:length(files)){
    file<-files[i]
    t<-tidync(file)%>% hyper_filter(lat = lat >= min(z$lat) & lat <= max(z$lat), lon = lon>= min(z$lon) & lon<= max(z$lon)) %>% hyper_tibble()
    # t$sst[t$sst == -9999] <- NA
    x<-t$sst
    x.sf<-t%>%st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
    
    bbox<-st_bbox(x.sf)
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    
    area <- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                           proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,)
    rm(box, bbox)
    
    t<-str_split(file, '\\.')
    t<-t[[1]][2]
    t<-str_split(t, "")
    y<-c(t[[1]][1:4])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)   
    yd<-c(t[[1]][5:7])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)
    origin<-toString(c(y,"-01-01")) %>% gsub(",","",.) %>% gsub(" ","",.)
    
    
    names(x.sf)<-c("value", "geometry")
    y<-f.grid_square_area2(x.sf)
    q<-y$grid_area$value/y$sum_grid_area
    wa<-sum(q*x)
   
    sst_integrated[i,1]<-as.character(as.Date(as.numeric(yd), origin=origin)) # date  
    sst_integrated[i,2]<-wa
    sst_integrated[i,3]<-mean(x) # vgpm_median
    sst_integrated[i,4]<-median(x) # vgpm_mean
    sst_integrated[i,5]<-var(x) # vgpm_variance
    sst_integrated[i,6]<-as.numeric(area) # window_area (m^2) 
    sst_integrated[i,7]<-y$sum_grid_area # sum_grid_area (m^2)
    
  }
  
  
  # n<-names(vgpm_integrated)
  # vgpm_integrated<-dplyr::select(vgpm_integrated, n[1], n[12], n[13], n[6], n[7], n[9], n[10], n[8],n[2], n[3],  n[11], n[4], n[5] )
  
  return(sst_integrated)}

f.chl_data_nc<-function(z){
  
  chl_integrated<-as.data.frame(matrix(ncol = 7, nrow =length(files)))
  names(chl_integrated)<-c("date",  "chl_mean (area weighted)", "chl_mean (basic)", "chl_median", "chl_variance", "window_area (m^2)", "sum_grid_area (m^2)")
  
  for(i in 1:length(files)){
    file<-files[i]
    t<-tidync(file)%>% hyper_filter(lat = lat >= min(z$lat) & lat <= max(z$lat), lon = lon>= min(z$lon) & lon<= max(z$lon)) %>% hyper_tibble()
    # t$sst[t$sst == -9999] <- NA
    x<-t$chl
    x.sf<-t%>%st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
    
    bbox<-st_bbox(x.sf)
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    
    area <- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                           proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,)
    rm(box, bbox)
    
    t<-str_split(file, '\\.')
    t<-t[[1]][2]
    t<-str_split(t, "")
    y<-c(t[[1]][1:4])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)   
    yd<-c(t[[1]][5:7])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)
    origin<-toString(c(y,"-01-01")) %>% gsub(",","",.) %>% gsub(" ","",.)
    
    
    names(x.sf)<-c("value", "geometry")
    y<-f.grid_square_area2(x.sf)
    q<-y$grid_area$value/y$sum_grid_area
    wa<-sum(q*x)
    
    chl_integrated[i,1]<-as.character(as.Date(as.numeric(yd), origin=origin)) # date  
    chl_integrated[i,2]<-wa
    chl_integrated[i,3]<-mean(x) # vgpm_median
    chl_integrated[i,4]<-median(x) # vgpm_mean
    chl_integrated[i,5]<-var(x) # vgpm_variance
    chl_integrated[i,6]<-as.numeric(area) # window_area (m^2) 
    chl_integrated[i,7]<-y$sum_grid_area # sum_grid_area (m^2)
    
  }
  
  
  # n<-names(vgpm_integrated)
  # vgpm_integrated<-dplyr::select(vgpm_integrated, n[1], n[12], n[13], n[6], n[7], n[9], n[10], n[8],n[2], n[3],  n[11], n[4], n[5] )
  
  return(chl_integrated)}
```


# Important objects and data sets
## temp load/save works save for next steps

# dont nessacrilt need this... do for coastline
```{r}
setwd(robj)
# bud_match<-readRDS("bud_match.R")

# match<-readRDS("match.R")
load("20220201_temp_workspace.RData")
rm(m.coast, database)

# save(function_variables, m.coast, database,  file="20220207_temp_workspace.RData")
# saveRDS(match, "match.R")
# saveRDS(bud_match, "bud_match.R")
```


## load basic hurdat

```{r}
setwd(wd)
setwd(robj)
# h<-get_hurdat(basin="EP")
# saveRDS(h, "r_objects/hurdat.R")

h<-readRDS("hurdat.R")
h$DateTime<-with_tz(h$DateTime, tz="UTC")
```


##loading  coastal subsetting objects 
- see script "GRL_Main_Figures.Rmd"
```{r}
setwd(gis_data)
coastline<-st_read("./ne_50m_land/ne_50m_land.shp") 
# ocean<-st_read("./ne_50m_ocean/ne_50m_ocean.shp") 
cl<-st_crop(coastline, xmin=function_variables$h.lon_min, ymin=function_variables$h.lat_min, xmax=function_variables$h.lon_max, ymax=function_variables$h.lat_max)
rm(coastline)
 m.coast <- ggplot()+ geom_sf(data =cl, size=0.5)+ theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
  theme_bw()+ theme(text = element_text(size =12)) 
# cl<-st_crop(coastline, xmin=-170, ymin=-20, xmax=-80, ymax=40) # change here based on desired figure size
# cl<-st_crop(coastline, xmin=min(h$Lon), ymin=min(h$Lat), xmax=max(h$Lon), ymax=max(h$Lat))
# oc<-st_crop(ocean, xmin=function_variables$h.lon_min, ymin=function_variables$h.lat_min, xmax=function_variables$h.lon_max, ymax=function_variables$h.lat_max)

```
## stations and buffer

```{r}
setwd(wd)
setwd(robj)

radii<-100000 ## radius in km for POC select

# radii<-2*radii ## for selecting TC that intesect

stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")

# st<-stations_positions_list[[3]][1,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=20.50006 +lon_0=-106.5006" )
# circle_1<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# rm(flat, st)

# st<-stations_positions_list[[3]][2,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=16.49850 +lon_0=-107.2007" )
# circle_2<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# rm(flat, st)

# st<-stations_positions_list[[3]][3,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=15.99901 +lon_0=-108.5020" )
# circle_3<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][4,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle_3.5<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

# st<-stations_positions_list[[3]][5,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=21.50061 +lon_0=-109.4999" )
# circle_4<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# 
# st<-stations_positions_list[[3]][6,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=24.69887 +lon_024.69887" )
# circle_5<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

rm(st, flat, stations_positions_list)

# save all
# station_circle_list<-list(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5 )
# rm(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5)
```


# loading POC

```{r}
setwd(wd)
setwd(robj)

# data<-read_rds("vgpm_integrated_20220512.R")
data<-read_rds("vgpm_integrated_all_years_202200607.R")
poc<-data$st3.5
rm(data)

```




# computing sst

## stations

```{r}

### stations ####
setwd(wd)
setwd(robj)
# 
stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")

st<-stations_positions_list[[3]][1,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=20.50006 +lon_0=-106.5006" )
circle_1<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
rm(flat, st)

st<-stations_positions_list[[3]][2,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=16.49850 +lon_0=-107.2007" )
circle_2<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
rm(flat, st)

st<-stations_positions_list[[3]][3,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=15.99901 +lon_0=-108.5020" )
circle_3<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][4,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle_3.5<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][5,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=21.50061 +lon_0=-109.4999" )
circle_4<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][6,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=24.69887 +lon_024.69887" )
circle_5<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

rm(st, flat, stations_positions_list)


#make a list for next steps

station_circle_list<-list(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5 )
rm(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5)

f.bbox<-function(x){
  z<-st_bbox(x)
  z<-data.frame(lon= c(z[[1]], z[[3]]), lat = c(z[[2]], z[[4]])) #%>% st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
  return(z)
}
station_box_list<-lapply(station_circle_list, f.bbox)
names(station_box_list)<-c("st1", "st2", "st3", "st3.5", "st4", "st5")
rm(station_circle_list)


```


## data selction

```{r}
setwd(wd)
# setwd(sst_data)
setwd(chl_data)
files<-list.files()
file<-files[1]

 t<-tidync(file)%>% hyper_filter(lat = lat >= min(z$lat) & lat <= max(z$lat), lon = lon>= min(z$lon) & lon<= max(z$lon)) %>% hyper_tibble()
```

```{r}

t.start<-Sys.time()
setwd(wd)
# setwd(sst_data)
setwd(chl_data)

files<-list.files()

z<-station_box_list[[4]]
# st35_sst_modis<-f.sst_data_nc(z)
st35_chl_modis<-f.chl_data_nc(z)

setwd(wd)
setwd(robj)
# saveRDS(st35_sst_modis, "st35_sst_modis.R")
saveRDS(st35_chl_modis, "st35_chl_modis.R")

t.end<-Sys.time()
r1.time<-t.end-t.start
f<-(paste0("data run time is ", as.character(r1.time)," and finshed at ", as.character(t.end)))

setwd(wd)

fileConn<-file("run_time.txt")
writeLines(f, fileConn)
close(fileConn)

system(poweroff)

```

```{r}

```


#selecting TCs by space and time
-requries POC for time window
```{r}

bbox<-st_bbox(circle_3.5)


# x<-filter(h, Status == "HU") %>% filter(., DateTime >=date(min(poc$date))-60) # save 'h' in order to adjust function variables if needed.
x<-filter(h, DateTime >=date(min(poc$date))-60) # save 'h' in order to adjust function variables if needed.
h.pts<- sf::st_as_sf(x, coords = c("Lon","Lat"), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") %>% 
sf::st_crop(., c(xmin=bbox$xmin[[1]], ymin=bbox$ymin[[1]], xmax=bbox$xmax[[1]], ymax=bbox$ymax[[1]])) #subset by user defined 

h.pts<-st_difference(h.pts, st_combine(st_geometry(cl))) # remove all points over land
rm(x)

```

#testing

```{r}
m.map<-m.coast+geom_sf(mapping = aes(col=Wind), data=h.pts, size=.25)+scale_color_cmocean(name="dense", direction= 1)+ggtitle(paste0("Hurricanes: ", function_variables$selection)) + labs(color = "Wind speed (m/s)")+theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
m.map
```

split and recombine
```{r}

t<-h.pts 
st_geometry(t)<-NULL
t$ymin<--Inf
t$ymax<-Inf

t$DateTime<-as.Date(t$DateTime)
t<-t[order(t$DateTime, decreasing = FALSE), ]
t<-t%>% group_by(Key)

h<-filter(t, Status == "HU")
p<-filter(t, Status != "HU")

t<-group_split(t)
t<-lapply(t, as.data.frame)

h<-group_split(h)
h<-lapply(h, as.data.frame)


# need to convert above using to this-> https://stackoverflow.com/questions/29648907/using-geom-rect-for-time-series-shading-in-r

start<-vector(mode="character", length=length(h))
end<-vector(mode="character", length=length(h))

for(i in 1:length(h)){
  start[[i]]<-as.character(min(h[[i]]$DateTime))
  end[[i]]<-as.character(max(h[[i]]$DateTime))
}
h_rect<-data.frame(start=date(start), end=date(end), y1=-Inf, y2=Inf)

start<-vector(mode="character", length=length(t))
end<-vector(mode="character", length=length(t))

for(i in 1:length(t)){
  start[[i]]<-as.character(min(t[[i]]$DateTime))
  end[[i]]<-as.character(max(t[[i]]$DateTime))
}

t_rect<-data.frame(start=date(start), end=date(end), y1=-Inf, y2=Inf)
# rm(t,h)

```




#plotting with tcs @ st3.5

```{r}
x<-poc
window_area<-round((x$`window_area (m^2)`[1]*1e-6),0)

lab_avg<-paste0("Station ", "3.5", ":", " Average Export Flux - ", window_area, " km^2 area")
lab_total<-paste0("Station ", "3.5", ":", " Total Export Flux - ", window_area, " km^2 area")

x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000
  
 # rectangel parameters:
rect_color<-"white"
sz<-0.25
alph<-.25
# rect_fill<-"cornsilk1" 
rect_fill<-"#fc8d62"
rect_fill_non<-"#8da0cb"
line_col<-"#66c2a5"
line_col<-"black"
```

```{r}

plot<- ggplot()+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=y2), color=rect_fill_non, fill=rect_fill_non, alpha=0.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=y2), color=rect_fill, fill=rect_fill, alpha=0.5)+
geom_line(data=x, aes(date, avg), color=line_col, lwd=1)+
theme_bw()+
ylab("Mean export flux (mgC/m^2/day)")+
scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
labs(title=lab_avg, caption = '8-Day resolution: Non-lagged EF. Colored lines are cyclones that pass within 400km^2 box around station 3.5: Orange = Hurricane strength,  Blue = less than " " ')+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
theme(axis.title.x=element_blank())

```


```{r}
plot<- ggplot()+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=geom_line(data=x, aes(date, avg))), color=rect_fill_non, fill=rect_fill_non, alpha=0.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=geom_line(data=x, aes(date, avg))), color=rect_fill, fill=rect_fill, alpha=0.5)+
geom_line(data=x, aes(date, avg), color=line_col, lwd=1)+
theme_bw()+
ylab("Mean export flux (mgC/m^2/day)")+
scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
labs(title=lab_avg, caption = '8-Day resolution: Non-lagged EF. Colored lines are cyclones that pass within 400km^2 box around station 3.5: Orange = Hurricane strength,  Blue = less than " " ')+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
theme(axis.title.x=element_blank())

```


```{r}
setwd(wd)
setwd(fig)

pdf("poc_averages_st3.5_with_TCs_within_200km.pdf", height=8.5 , width =16)
plot
dev.off()

```




# plotting v2 fx here f needed

```{r}


# setwd(wd)
# setwd(robj)
# 
# # data<-read_rds("vgpm_integrated_20220512.R")
# data<-read_rds("vgpm_integrated_all_years_202200607.R")


# f.poc_plots<-function(x){}
# see https://stackoverflow.com/questions/9469504/access-and-preserve-list-names-in-lapply-function


plots_avg<-vector(mode="list", length(data))
plots_total<-vector(mode="list", length(data))
station_number<-c("1", "2", "3", "3.5", "4", "5")
window_area<-c(round((data$st1$`window_area (m^2)`[1]*1e-6),0), round((data$st2$`window_area (m^2)`[1]*1e-6),0), round((data$st3$`window_area (m^2)`[1]*1e-6),0), round((data$st3.5$`window_area (m^2)`[1]*1e-6),0), round((data$st4$`window_area (m^2)`[1]*1e-6),0), round((data$st5$`window_area (m^2)`[1]*1e-6),0))



rects<- data.frame(x1=seq(as.Date('2002-05-15'), length.out=20, by="years"),
        x2=seq(as.Date('2002-11-30'),length.out=20, by="years"))

rects$y1<-Inf
rects$y2<-Inf

# rectangel parameters:
rect_color<-NA
sz<-0.25
alph<-.25
rect_fill<-"cornsilk1"   

  
# x<-data$st5
x<-data[[i]]
lab_avg<-paste0("Station ", station_number[i], ":", " Average Export Flux - ", window_area[i], " km^2 area")
lab_total<-paste0("Station ", station_number[i], ":", " Total Export Flux - ", window_area[i], " km^2 area")

x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

# x$l<-log10(x$ef)
plots_total[[i]]<- ggplot(x, aes(x=date, y=ef)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[7], xmax = rects$x2[7] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[8], xmax = rects$x2[8] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[9], xmax = rects$x2[9] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[10], xmax = rects$x2[10] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[11], xmax = rects$x2[11] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[12], xmax = rects$x2[12] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[13], xmax = rects$x2[13] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[14], xmax = rects$x2[14] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[15], xmax = rects$x2[15] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[16], xmax = rects$x2[16] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[17], xmax = rects$x2[17] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[18], xmax = rects$x2[18] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[19], xmax = rects$x2[19] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[20], xmax = rects$x2[20] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_point()+
  theme_bw()+
  ylab("Export flux (kg C/day)")+
  labs(title=lab_total,
  caption = "8-Day resolution: Non-lagged EF. Colored boxes: Climatological Cyclone Season (05-15 to 11-30)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())
 

#, date_minor_breaks = "1 month"

 # xlab("8-day Integration")+
plots_avg[[i]]<- ggplot(x, aes(x=date, y=avg)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[7], xmax = rects$x2[7] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[8], xmax = rects$x2[8] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[9], xmax = rects$x2[9] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[10], xmax = rects$x2[10] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[11], xmax = rects$x2[11] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[12], xmax = rects$x2[12] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[13], xmax = rects$x2[13] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[14], xmax = rects$x2[14] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[15], xmax = rects$x2[15] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[16], xmax = rects$x2[16] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[17], xmax = rects$x2[17] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[18], xmax = rects$x2[18] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[19], xmax = rects$x2[19] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[20], xmax = rects$x2[20] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_point()+
  theme_bw()+
  ylab("Mean export flux (mgC/m^2/day)")+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  labs(title=lab_avg, caption = "8-Day resolution: Non-lagged EF. Colored boxes: Climatological Cyclone Season (05-15 to 11-30)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())
   
rm(x)         
                       
}

```


```{r}
library(cowplot)
setwd(wd)
setwd(fig)
a1<-list(plots_avg[[1]], plots_avg[[2]], plots_avg[[3]])
a2<-list(plots_avg[[4]], plots_avg[[5]], plots_avg[[6]])

pdf("poc_averages_1.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = a1, nrow=3, ncol=1)
dev.off()

pdf("poc_averages_2.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = a2, nrow=3, ncol=1)
dev.off()

t1<-list(plots_total[[1]], plots_total[[2]], plots_total[[3]])
t2<-list(plots_total[[4]], plots_total[[5]], plots_total[[6]])

pdf("poc_totals_1.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = t1, nrow=3, ncol=1)
dev.off()

pdf("poc_totals_2.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = t2, nrow=3, ncol=1)
dev.off()



```







 #plotting (old cod fro chl, tmep and staion boxes) suplemtary figure

```{r}
i<-4
x<-data[[i]]
x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

rect_color<-"red"

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

t<- ggplot(x, aes(x=date, y=ef)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=NA, colour=rect_color, size=0.5, alpha=0.2)+
  geom_point()+
  ylab("Export flux (kg C/day)")+
  labs(title=lab_total,
  caption = "8-Day resolution: non-lagged EF")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())




```


```




