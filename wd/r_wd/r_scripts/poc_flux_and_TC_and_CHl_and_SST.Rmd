---
title: "poc_flux_and_TC_and_CHl_and_SST"
author: "Brandon M. Genco"
date: "06/15/2022"
output: html_document
---
code repurposed from "Hurricane 0instu_matchup_2.rmd"

# Setup
## Directories and defaults
Use r proj file for relative directories
see: https://yihui.org/knitr/options/


```{r setup}
rm(list=ls())
# relative directories
robj<-"r_objects"
fig<-"../../figures"
gis_data<-"../../data/gis_data"
output<-"../../output"

sst_data<-"../../data/POC_Flux_data_sets/annual_vgpm_modis_sst_netcdf"
chl_data<-"../../data/POC_Flux_data_sets/annual_vgpm_modis_chl_netcdf"
 
#absolute directory
# drop_img<-"/home/brandon/Dropbox/MERCED/dissertation/presentations/images"

knitr::opts_chunk$set(echo =FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

## packages and work direcorty

Installed custom hurdat package using r markdown menu
* download  tar from archive as no longer maintained on cran repository
* https://cran.r-project.org/src/contrib/Archive/HURDAT/
+ include as git submodule instead

```{r}
wd<-getwd()

f.ipak <- function(pkg){
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}

# packages<-c("stars", "gridExtra", "cowplot", "sf", "ggspatial","stringr","sp", "rgdal",  "rgeos", "raster","readr" ,"tidyverse", "ggplot2", "lubridate",  "ggthemes", "data.table", "reshape2", "RColorBrewer", "marmap", "extrafont", "oce", "MODIS", "measurements")  # set packages here
# tidyverse: is all of the following packages: ggplot2, dplyr, tidyr, readr, purr, tibble, sringr, & forcats.

packages<-c("sp", "rgdal",  "rgeos", "raster", "readr", "tidyverse", "lubridate",  "ggthemes",  "sf", "cmocean", "ncdf4", "RNetCDF",  "plot3D", "tidync", "devtools", "stars", "ncmeta", "maps", "oce", "data.table", "fasterize", "RStoolbox", "scales", "purrr", "HURDAT", "ggpattern")

# "HURDAT",

f.ipak(packages)
# lapply(packages, require, character.only = TRUE)
# rm(f.ipak, packages)
print(paste0("Current Working Directory is ", getwd()))

```

## functions

```{r}
f.grid_square_area2<-function(x) {
  x.area<-vector(mode="numeric", length = nrow(x)) 
  
  for(i in 1:length(x.area)){
    bbox<-st_bbox(x[[2]][[i]])
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    x.area[i]<- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                               proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,) %>% round(., -1)
  }
  sum_grid_area<-sum(x.area)
  x$value<-x.area
  y<-vector(mode = "list", length=2)
  names(y)<-c("grid_area", "sum_grid_area")
  y$grid_area<-x
  y$sum_grid_area<-sum_grid_area
  
  return(y)}

f.sst_data_nc<-function(z){
  
  sst_integrated<-as.data.frame(matrix(ncol = 7, nrow =length(files)))
  names(sst_integrated)<-c("date",  "SST_mean (area weighted)", "SST_mean (basic)", "SST_median", "SST_variance", "window_area (m^2)", "sum_grid_area (m^2)")
  
  for(i in 1:length(files)){
    file<-files[i]
    t<-tidync(file)%>% hyper_filter(lat = lat >= min(z$lat) & lat <= max(z$lat), lon = lon>= min(z$lon) & lon<= max(z$lon)) %>% hyper_tibble()
    # t$sst[t$sst == -9999] <- NA
    x<-t$sst
    x.sf<-t%>%st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
    
    bbox<-st_bbox(x.sf)
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    
    area <- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                           proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,)
    rm(box, bbox)
    
    t<-str_split(file, '\\.')
    t<-t[[1]][2]
    t<-str_split(t, "")
    y<-c(t[[1]][1:4])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)   
    yd<-c(t[[1]][5:7])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)
    origin<-toString(c(y,"-01-01")) %>% gsub(",","",.) %>% gsub(" ","",.)
    
    
    names(x.sf)<-c("value", "geometry")
    y<-f.grid_square_area2(x.sf)
    q<-y$grid_area$value/y$sum_grid_area
    wa<-sum(q*x)
   
    sst_integrated[i,1]<-as.character(as.Date(as.numeric(yd), origin=origin)) # date  
    sst_integrated[i,2]<-wa
    sst_integrated[i,3]<-mean(x) # vgpm_median
    sst_integrated[i,4]<-median(x) # vgpm_mean
    sst_integrated[i,5]<-var(x) # vgpm_variance
    sst_integrated[i,6]<-as.numeric(area) # window_area (m^2) 
    sst_integrated[i,7]<-y$sum_grid_area # sum_grid_area (m^2)
    
  }
  
  
  # n<-names(vgpm_integrated)
  # vgpm_integrated<-dplyr::select(vgpm_integrated, n[1], n[12], n[13], n[6], n[7], n[9], n[10], n[8],n[2], n[3],  n[11], n[4], n[5] )
  
  return(sst_integrated)}

f.chl_data_nc<-function(z){
  
  chl_integrated<-as.data.frame(matrix(ncol = 7, nrow =length(files)))
  names(chl_integrated)<-c("date",  "chl_mean (area weighted)", "chl_mean (basic)", "chl_median", "chl_variance", "window_area (m^2)", "sum_grid_area (m^2)")
  
  for(i in 1:length(files)){
    file<-files[i]
    t<-tidync(file)%>% hyper_filter(lat = lat >= min(z$lat) & lat <= max(z$lat), lon = lon>= min(z$lon) & lon<= max(z$lon)) %>% hyper_tibble()
    # t$sst[t$sst == -9999] <- NA
    x<-t$chl
    x.sf<-t%>%st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
    
    bbox<-st_bbox(x.sf)
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    
    area <- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                           proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,)
    rm(box, bbox)
    
    t<-str_split(file, '\\.')
    t<-t[[1]][2]
    t<-str_split(t, "")
    y<-c(t[[1]][1:4])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)   
    yd<-c(t[[1]][5:7])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)
    origin<-toString(c(y,"-01-01")) %>% gsub(",","",.) %>% gsub(" ","",.)
    
    
    names(x.sf)<-c("value", "geometry")
    y<-f.grid_square_area2(x.sf)
    q<-y$grid_area$value/y$sum_grid_area
    wa<-sum(q*x)
    
    chl_integrated[i,1]<-as.character(as.Date(as.numeric(yd), origin=origin)) # date  
    chl_integrated[i,2]<-wa
    chl_integrated[i,3]<-mean(x) # vgpm_median
    chl_integrated[i,4]<-median(x) # vgpm_mean
    chl_integrated[i,5]<-var(x) # vgpm_variance
    chl_integrated[i,6]<-as.numeric(area) # window_area (m^2) 
    chl_integrated[i,7]<-y$sum_grid_area # sum_grid_area (m^2)
    
  }
  
  
  # n<-names(vgpm_integrated)
  # vgpm_integrated<-dplyr::select(vgpm_integrated, n[1], n[12], n[13], n[6], n[7], n[9], n[10], n[8],n[2], n[3],  n[11], n[4], n[5] )
  
  return(chl_integrated)}
```


# Important objects and data sets
## temp load/save works save for next steps

# dont nessacrilt need this... do for coastline
```{r}
setwd(wd)
setwd(robj)

# bud_match<-readRDS("bud_match.R")
# match<-readRDS("match.R")
load("20220201_temp_workspace.RData")
rm(m.coast, database)

# save(function_variables, m.coast, database,  file="20220207_temp_workspace.RData")
# saveRDS(match, "match.R")
# saveRDS(bud_match, "bud_match.R")
```


## load basic hurdat

```{r}
setwd(wd)
setwd(robj)
# h<-get_hurdat(basin="EP")
# saveRDS(h, "hurdat.R")

h<-readRDS("hurdat.R")
h$DateTime<-with_tz(h$DateTime, tz="UTC")
```


##loading  coastal subsetting objects 
- see script "GRL_Main_Figures.Rmd"
```{r}
setwd(wd)
setwd(gis_data)
coastline<-st_read("./ne_50m_land/ne_50m_land.shp") 
# ocean<-st_read("./ne_50m_ocean/ne_50m_ocean.shp") 
cl<-st_crop(coastline, xmin=function_variables$h.lon_min, ymin=function_variables$h.lat_min, xmax=function_variables$h.lon_max, ymax=function_variables$h.lat_max)
rm(coastline)
 m.coast <- ggplot()+ geom_sf(data =cl, size=0.5)+ theme(axis.title.x=element_blank(), axis.title.y=element_blank())+
  theme_bw()+ theme(text = element_text(size =12)) 
# cl<-st_crop(coastline, xmin=-170, ymin=-20, xmax=-80, ymax=40) # change here based on desired figure size
# cl<-st_crop(coastline, xmin=min(h$Lon), ymin=min(h$Lat), xmax=max(h$Lon), ymax=max(h$Lat))
# oc<-st_crop(ocean, xmin=function_variables$h.lon_min, ymin=function_variables$h.lat_min, xmax=function_variables$h.lon_max, ymax=function_variables$h.lat_max)

```
## stations and buffer

```{r}
setwd(wd)
setwd(robj)

radii<-100000 ## radius in km for POC select

# radii<-2*radii ## for selecting TC that intesect

stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")

# st<-stations_positions_list[[3]][1,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=20.50006 +lon_0=-106.5006" )
# circle_1<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# rm(flat, st)

# st<-stations_positions_list[[3]][2,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=16.49850 +lon_0=-107.2007" )
# circle_2<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# rm(flat, st)

# st<-stations_positions_list[[3]][3,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=15.99901 +lon_0=-108.5020" )
# circle_3<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][4,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle_3.5<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

# st<-stations_positions_list[[3]][5,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=21.50061 +lon_0=-109.4999" )
# circle_4<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# 
# st<-stations_positions_list[[3]][6,cbind(2,3)]
# st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
# flat<-sf::st_transform(st, "+proj=aeqd +lat_0=24.69887 +lon_024.69887" )
# circle_5<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

rm(st, flat, stations_positions_list)

# save all
# station_circle_list<-list(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5 )
# rm(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5)
```


# loading POC

```{r}
setwd(wd)
setwd(robj)

# data<-read_rds("vgpm_integrated_20220512.R")
data<-read_rds("vgpm_integrated_all_years_202200607.R")
poc<-data$st3.5
sst<-readRDS("st35_sst_modis.R")
chl<-readRDS("st35_chl_modis.R")

x<-poc
window_area<-round((x$`window_area (m^2)`[1]*1e-6),0)


# lab_avg<-'8-Day resolution: Non-lagged EF (proportion of modeled VGPM). Colored lines are individual tropical disturbances that pass within the export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " " '
lab_total<-paste0("Station ", "3.5", ":", " Total Export Flux - ", window_area, " km^2 area")

x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000


y<-select(chl, date, 'chl_mean (area weighted)')
names(y)<-c("date", "chl")
y$date<-ymd(y$date)

z<-select(sst, date, `SST_mean (area weighted)`)
names(z)<-c("date", "sst")
z$date<-ymd(z$date)



rm(data, sst, chl)

```




# computing sst

## stations

```{r}

### stations ####
setwd(wd)
setwd(robj)
# 
stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")

st<-stations_positions_list[[3]][1,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=20.50006 +lon_0=-106.5006" )
circle_1<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
rm(flat, st)

st<-stations_positions_list[[3]][2,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=16.49850 +lon_0=-107.2007" )
circle_2<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
rm(flat, st)

st<-stations_positions_list[[3]][3,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=15.99901 +lon_0=-108.5020" )
circle_3<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][4,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle_3.5<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][5,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=21.50061 +lon_0=-109.4999" )
circle_4<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][6,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=24.69887 +lon_024.69887" )
circle_5<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

rm(st, flat, stations_positions_list)


#make a list for next steps

station_circle_list<-list(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5 )
rm(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5)

f.bbox<-function(x){
  z<-st_bbox(x)
  z<-data.frame(lon= c(z[[1]], z[[3]]), lat = c(z[[2]], z[[4]])) #%>% st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
  return(z)
}
station_box_list<-lapply(station_circle_list, f.bbox)
names(station_box_list)<-c("st1", "st2", "st3", "st3.5", "st4", "st5")
rm(station_circle_list)


```


## file read in and selection form NC files

```{r}

t.start<-Sys.time()
setwd(wd)
# setwd(sst_data)
setwd(chl_data)

files<-list.files()

z<-station_box_list[[4]]
# st35_sst_modis<-f.sst_data_nc(z)
st35_chl_modis<-f.chl_data_nc(z)

setwd(wd)
setwd(robj)
# saveRDS(st35_sst_modis, "st35_sst_modis.R")
saveRDS(st35_chl_modis, "st35_chl_modis.R")

t.end<-Sys.time()
r1.time<-t.end-t.start
f<-(paste0("data run time is ", as.character(r1.time)," and finshed at ", as.character(t.end)))

setwd(wd)

fileConn<-file("run_time.txt")
writeLines(f, fileConn)
close(fileConn)

system("poweroff")

```


# selecting TCs by space and time
-requires POC for time window
```{r}

bbox<-st_bbox(circle_3.5)

# x<-filter(h, Status == "HU") %>% filter(., DateTime >=date(min(poc$date))-60) # save 'h' in order to adjust function variables if needed.
g<-filter(h, DateTime >=date(min(poc$date))-60) # save 'h' in order to adjust function variables if needed.
h.pts<- sf::st_as_sf(g, coords = c("Lon","Lat"), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") %>% 
sf::st_crop(., c(xmin=bbox$xmin[[1]], ymin=bbox$ymin[[1]], xmax=bbox$xmax[[1]], ymax=bbox$ymax[[1]])) #subset by user defined 

# h.pts<-st_difference(h.pts, st_combine(st_geometry(cl))) # remove all points over land
rm(g)

```

## testing map

```{r}
m.map<-m.coast+geom_sf(mapping = aes(col=Wind), data=h.pts, size=.25)+scale_color_cmocean(name="dense", direction= 1)+ggtitle(paste0("Hurricanes: ", function_variables$selection)) + labs(color = "Wind speed (m/s)")+theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
m.map
```

## split and recombine
```{r}
t<-h.pts 
st_geometry(t)<-NULL
t$ymin<--Inf
t$ymax<-Inf
# t$DateTime<-as.Date(t$DateTime)
t$DateTime<-as_datetime(t$DateTime)

 unique(t$Status)
 
# see:  https://www.nhc.noaa.gov/data/hurdat/hurdat2-format-atl-1851-2021.pdf
#"TS" tropical cyclone of tropical storm intensity (34-63 knots)
# "TD" Tropical cyclone of tropical depression intensity (< 34 knots)
# LO – A low that is neither a tropical cyclone, a subtropical cyclone, nor an extratropical cyclone (of any intensity)
# DB – Disturbance (of any intensity)
# splits in invidiaudla storms to hurricanes and all else. If an individual storm was bot bleow and a husrrcian and a hurricane in teh subste it mark it as a hurricane

 
 remove_200<-unique(t$Key)
 
h<-t%>% group_by(Key) %>% filter(any(Status== "HU"))
t<-t %>% subset(., !(Key %in% unique(h$Key)))%>% group_by(Key)

t<-group_split(t)
t<-lapply(t, as.data.frame)

h<-group_split(h)
h<-lapply(h, as.data.frame)

# need to convert above using to this-> https://stackoverflow.com/questions/29648907/using-geom-rect-for-time-series-shading-in-r

start<-vector(mode="character", length=length(h))
end<-vector(mode="character", length=length(h))
pres<-vector(mode="integer", length=length(h))

for(i in 1:length(h)){
  start[[i]]<-as.character(min(h[[i]]$DateTime))
  end[[i]]<-as.character(max(h[[i]]$DateTime))
  pres[[i]]<-median(h[[i]]$Pressure)
  # pres[[i]]<-min(h[[i]]$Pressure)
}

h_rect<-data.frame(start=date(start), end=date(end), y1=-Inf, y2=pres)

start<-vector(mode="character", length=length(t))
end<-vector(mode="character", length=length(t))
pres<-vector(mode="integer", length=length(t))

for(i in 1:length(t)){
  start[[i]]<-as.character(min(t[[i]]$DateTime))
  end[[i]]<-as.character(max(t[[i]]$DateTime))
  pres[[i]]<-median(t[[i]]$Pressure)
  #   
}

t_rect<-data.frame(start=date(start), end=date(end), y1=-Inf, y2=pres)
rm(t,h)



#standar atmospheirc presures in millibars


```


# 400 km storms only

_so 440 with 200 excluded.. prob



```{r}
setwd(wd)
setwd(robj)


h<-readRDS("hurdat.R")
h$DateTime<-with_tz(h$DateTime, tz="UTC")

radii<-100000 ## radius in km for POC select

radii<-2*radii ## for selecting TC that intesect

stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")

st<-stations_positions_list[[3]][4,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle_3.5_400km<-sf::st_buffer(flat, dist=radii)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

bbox<-st_bbox(circle_3.5_400km)

# x<-filter(h, Status == "HU") %>% filter(., DateTime >=date(min(poc$date))-60) # save 'h' in order to adjust function variables if needed.
g<-filter(h, DateTime >=date(min(poc$date))-60) # save 'h' in order to adjust function variables if needed.
h.pts<- sf::st_as_sf(g, coords = c("Lon","Lat"), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") %>% 
sf::st_crop(., c(xmin=bbox$xmin[[1]], ymin=bbox$ymin[[1]], xmax=bbox$xmax[[1]], ymax=bbox$ymax[[1]])) #subset by user defined 

# h.pts<-st_difference(h.pts, st_combine(st_geometry(cl))) # remove all points over land
rm(g, poc)

t_4<-h.pts 
st_geometry(t_4)<-NULL
t_4$ymin<--Inf
t_4$ymax<-Inf
# t$DateTime<-as.Date(t$DateTime)
t_4$DateTime<-as_datetime(t_4$DateTime)

t_4<-t_4 %>% subset(., !(Key %in% remove_200))%>% group_by(Key)




t_4<-group_split(t_4)
t_4<-lapply(t_4, as.data.frame)

start<-vector(mode="character", length=length(t_4))
end<-vector(mode="character", length=length(t_4))
pres<-vector(mode="integer", length=length(t_4))

for(i in 1:length(t_4)){
  start[[i]]<-as.character(min(t_4[[i]]$DateTime))
  end[[i]]<-as.character(max(t_4[[i]]$DateTime))
  pres[[i]]<-median(t_4[[i]]$Pressure)
  #
}

t_4_rect<-data.frame(start=date(start), end=date(end), y1=-Inf, y2=pres)

rm(remove_200)


```

## saving hurricane objects for plotting. temp _action
```{r}

storms_around_st3.5<-vectot(mode="list")
storms_around_st3.5$t<-t
storms_around_st3.5$t<-t


```


# plotting with tcs @ st3.5
```{r}


```



variables for a ---> ? and sime seris plots

```{r}

w<-inner_join(x,y, by='date') %>% inner_join(., z,  by='date' ) %>% select(., - ef)
# rm(poc, chl, sst)

#save original for scale etc
rects<-vector(mode="list")
rects$t<-t_rect
rects$h<-h_rect
rects$t_4<-t_4_rect


#   Saving hurricane objects for plotting. temp _action
# setwd(wd)
# setwd(robj)
# saveRDS( rects, "storms_around_st3_5_20220705.R")




 # rectangel parameters:
rect_color<-"white"
sz<-0.25
alph<-.25
# rect_fill<-"cornsilk1" 
rect_fill<-"#fc8d62"
rect_fill_non<-"#8da0cb"
# rect_fill_outside<-"#66c2a5"
 # rect_fill_outside<-"grey48"
rect_fill_outside<-"gray38"


# line colors

line_col<-"#66c2a5"
line_col<-"black"
tcolor<-"red"
chcolor<-"darkgreen"


title<-paste0("Station ", "3.5", ": ", "Positive Anomaly Average Export Flux - ", window_area, " km^2 area")
capt<-'8-Day resolution: Non-lagged EF (proportion of modeled VGPM). Positve aanomalies only (above or eqaul to mean). Colored lines are individual tropical disturbances that pass within the export flux box around station 3.5 \nOrange = Hurricane strength,  Blue = less than " ". Grey dashed horizontal line is 1 SD (σ) above mean export flux for time series. 1013.25 mb is standard atmospheric pressue at sea level for reference.'
ylab<-"Mean export flux (mgC/m^2/day)"
ylab2<-"Cyclone eye pressure - millibars (mb)"
panel<-"a"
atxt<-list(title, capt, ylab, ylab2, panel)
names(atxt)<-c("title", "capt", "ylab", "ylab2", "panel")

title<-paste0("Station ", "3.5", ": ", "Average Export Flux and Chlorophyll-a - ", window_area, " km^2 area")
capt<-'8-Day resolution: Non-lagged EF (proportion of modeled VGPM). MODIS derived Chl-a in green. Input of VGPM NPP model. \nDashed horizontal lines are 1 SD (σ) above mean for time series (EF = grey, chl-a = green).'
ylab2<-"Chlorophyll-a [μg/L]"
panel<-"b"
btxt<-list(title, capt, ylab, ylab2, panel)
names(btxt)<-c("title", "capt", "ylab", "ylab2", "panel")


title<-paste0("Station ", "3.5", ": ", "Average Export Flux and SST - ", window_area, " km^2 area")
capt<-'8-Day resolution: Non-lagged EF (proportion of modeled VGPM). MODIS derived SST in red. Input of VGPM NPP model. \nDashed horizontal lines are 1 SD (σ) above/below mean for time series (EF = grey, SST =red).'
ylab2<-"SST (°C)"
panel<-"c"
ctxt<-list(title, capt, ylab, ylab2, panel)
names(ctxt)<-c("title", "capt", "ylab", "ylab2", "panel")

title<-paste0("Station ", "3.5", ": ", "Chlorophyll-a and SST - ", window_area, " km^2 area")
capt<-'MODIS derived Chl-a in green, and SST in red. Inputs of VGPM NPP model. \nDashed lines are 1 SD (σ) above/below mean for time series (chl-a = green, SST =red).'
ylab<-"Chlorophyll-a [μg/L]"
ylab2<-"SST (°C)"
panel<-"d"
dtxt<-list(title, capt, ylab, ylab2, panel)
names(dtxt)<-c("title", "capt", "ylab", "ylab2", "panel")

title<-paste0("Station ", "3.5", ": ", "Chlorophyll-a and storms within 400km^2 box - ", window_area, " km^2 area")
capt<-'MODIS derived Chl-a in green. Input of VGPM NPP model. Colored lines are individual tropical disturbances that pass within the export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " ". \nStorms outside flux box but wihin 400km^2 in grey (dashed). Green dashed horizontal line is mean Chl-a for time series. 1013.25 mb is standard atmospheric pressue at sea level for reference.'
ylab<-"Chlorophyll-a [μg/L]"
ylab2<-"Cyclone eye pressure - millibars (mb)"
panel<-"e"
etxt<-list(title, capt, ylab, ylab2, panel)
names(etxt)<-c("title", "capt", "ylab", "ylab2", "panel")

title<-paste0("Station ", "3.5", ": ", "SST and storms within 400km^2 box - ", window_area, " km^2 area")
capt<-'MODIS derived SST in red. Input of VGPM NPP model. Colored lines are individual tropical disturbances that pass within the export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " ". \nStorms outside flux box but wihin 400km^2 in grey (dashed). Red dashed horizontal line is mean SST for time series. 1013.25 mb is standard atmospheric pressue at sea level for reference.'
ylab<-"SST (°C)"
panel<-"f"
ftxt<-list(title, capt, ylab, ylab2, panel)
names(ftxt)<-c("title", "capt", "ylab", "ylab2", "panel")


title<-paste0("Station ", "3.5", ": ", "Average Export Flux and storms within 400km^2 box - ", window_area, " km^2 area")
capt<-'8-Day resolution: Non-lagged EF (proportion of modeled VGPM). Colored lines are individual tropical disturbances that pass within the export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " ". \nStorms outside flux box but wihin 400km^2 in grey (dashed). Blackdashed horizontal line is mean export flux for time series. 1013.25 mb is standard atmospheric pressue at sea level for reference.'
ylab<-"Mean export flux (mgC/m^2/day)"
panel<-"g"
gtxt<-list(title, capt, ylab, ylab2, panel)
names(gtxt)<-c("title", "capt", "ylab", "ylab2", "panel")

plot_list<-vector(mode="list")

```




## plot a
-Above aver poc and 200km TS
```{r}

w<-inner_join(x,y, by='date') %>% inner_join(., z,  by='date' ) %>% select(., - ef)
h_rect<-rects$h
t_rect<-rects$t

txt<-atxt
stdp<-1013.25
adj<-stdp+3.45*(stdp-min(h_rect$y2))

h_rect$y2<-abs(h_rect$y2-adj)
t_rect$y2<-abs(t_rect$y2-adj)

# ` hurrican categories

#1 > 980
#2 965 to 979
#3 945 to 964
#4 920 to 944
#5  < 920 

a.breaks<-c( 872, 900, 920, plyr::round_any((944+920)/2, 5, f=floor), plyr::round_any((964+945)/2, 5, f=ceiling), plyr::round_any((979+965)/2,5, f=floor), 980, 1000) %>% round(., 0) %>% append(., c(round(stdp,2),  round(adj,2)))

a.labs<-(a.breaks)
a.breaks<-abs(a.breaks-adj)

scale.a<-(max(w$avg)/max(c(t_rect$y2, h_rect$y2)))
poc_lim<-mean(w$avg)


plot_a<- ggplot()+ theme_bw()+
geom_hline(yintercept=(mean(w$avg)+sd(w$avg)), data=w, linetype="dashed", color ="grey")+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.a), color=rect_fill_non, fill=rect_fill_non, alpha=0.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.a), color=rect_fill, fill=rect_fill, alpha=0.5)+
geom_point(data=w, aes(date, avg), color=line_col, lwd=1)+
  
scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.a, name=txt$ylab2,  breaks = a.breaks , labels= a.labs), limits = c(poc_lim, NA))+
labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)


plot_list$a<-plot_a
# rm(scale, poc_lim, a.labs, a.breaks, txt)
 
#old

# geom_line(data=x, aes(date, avg), color=line_col, lwd=1)+
# scale_y_continuous(name ="Mean export flux (mgC/m^2/day)", labels = function(x) format(x, scientific = TRUE),


# a.breaks<-c( 872, 900, 920, plyr::round_any((944+920)/2, 5, f=floor), plyr::round_any((964+945)/2, 5, f=ceiling), plyr::round_any((979+965)/2,5, f=floor), 980, 1000) %>% round(., 0) %>% append(., c(round(stdp,2)))
# p.breaks<-c(872, 900, 920, 940, 960, 980, 1000, stdp, adj)
# labs<-p.breaks


# poc_lim<-mean(x$avg)-sd(x$avg)
# scale.pres<-(max(x$avg)-min(x$avg))/max(c(t_rect$y2, h_rect$y2)) # puts bars in midlle of graph
# poc_lim<-NA

# capt<-'8-Day resolution: Non-lagged EF (proportion of modeled VGPM). Colored lines are individual tropical disturbances that pass within the export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " " '
# ggplot2::theme_update(plot.tag = element_text(face = "bold"))


```

## Plot b
- poc and chl
```{r}
txt<-btxt
w<-inner_join(x,y, by='date') %>% inner_join(., z,  by='date' ) %>% select(., - ef)
scale.b<-max(w$avg)/max(w$chl)


plot_b<- ggplot()+ theme_bw()+
geom_hline(yintercept=(mean(w$avg)+sd(w$avg)), data=w, linetype="dashed", color ="grey")+
geom_hline(yintercept=scale.b*(mean(w$chl)+sd(w$chl)), data=w, linetype="dashed", color =chcolor)+
geom_line(data=w, aes(date, avg), color=line_col, lwd=.5)+
geom_line(data=w, aes(date, chl*scale.b), color=chcolor, lwd=.5)+
scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.b, name=txt$ylab2))+

labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)   

plot_list$b<-plot_b
# rm(scale, txt)

```

## Plot c

poc and sst
```{r}
txt<-ctxt
w<-inner_join(x,y, by='date') %>% inner_join(., z,  by='date' ) %>% select(., - ef)


# t.breaks<-(summary(z$sst))
# t.breaks<- as.vector(unname(t.breaks[-3])) # rmoves median

c.breaks<-seq(from=22, to =27, by =1)
labs<-c.breaks

adj<-floor(min(w$sst))
# labs<-plyr::round_any(t.breaks, 1, f=round)

c.breaks<-c.breaks-adj
w$sst<-w$sst-adj
scale.c<-max(w$avg)/max(w$sst)


plot_c<- ggplot()+ theme_bw()+
geom_hline(yintercept=(mean(w$avg)+sd(w$avg)), data=w, linetype="dashed", color ="grey")+
geom_hline(yintercept=scale.c*(mean(w$sst)-sd(w$sst)), data=z, linetype="dashed", color =tcolor)+
geom_line(data=w, aes(date, avg), color=line_col, lwd=.5)+
geom_line(data=w, aes(date, sst*scale.c), color=tcolor, lwd=.5)+
scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.c, name=txt$ylab2, breaks = c.breaks, labels= labs))+

labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)

plot_list$c<-plot_c
# rm(txt, labs, c.breaks)


```

## Plot d 
-chl and sst
```{r}
txt<-dtxt
w<-inner_join(x,y, by='date') %>% inner_join(., z,  by='date' ) %>% select(., - ef)

d.breaks<-seq(from=22, to =27, by =1)
labs<-d.breaks

adj<-floor(min(w$sst))
# labs<-plyr::round_any(t.breaks, 1, f=round)

d.breaks<-d.breaks-adj
w$sst<-w$sst-adj

scale.d<-max(w$chl)/max(w$sst)



plot_d<- ggplot()+ theme_bw()+
geom_hline(yintercept=(mean(w$chl)+sd(w$chl)), data=w, linetype="dashed", color =chcolor)+
geom_hline(yintercept=scale.d*(mean(w$sst)-sd(w$sst)), data=w, linetype="dashed", color =tcolor)+
geom_line(data=w, aes(date, sst*scale.d), color=tcolor, lwd=.5)+
geom_line(data=w, aes(date, chl), color=chcolor, lwd=.5)+

scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.d, name=txt$ylab2, breaks = d.breaks, labels= labs))+

labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)

plot_list$d<-plot_d
# rm(labs, adj, w, scale, d.breaks)

```


## plot_e

chl & ts

```{r}

# rect_fill_outside<-"gray38"
# rect_fill<-"black"
# rect_fill_non<-"black"


txt<-etxt

w<-inner_join(x,y, by='date') %>% inner_join(., z, by='date' ) %>% select(., - ef)
h_rect<-rects$h
t_rect<-rects$t
t_4_rect<-rects$t_4

stdp<-1013.25
ff<-2
adj<-stdp+ff*(stdp-min(h_rect$y2))

h_rect$y2<-abs(h_rect$y2-adj)
t_rect$y2<-abs(t_rect$y2-adj)
t_4_rect$y2<-abs(t_4_rect$y2-adj)

# ` hurrican categories

#1 > 980
#2 965 to 979
#3 945 to 964
#4 920 to 944
#5  < 920 

e.breaks<-c( 872, 900, 920, plyr::round_any((944+920)/2, 5, f=floor), plyr::round_any((964+945)/2, 5, f=ceiling), plyr::round_any((979+965)/2,5, f=floor), 980, 1000) %>% round(., 0) %>% append(., c(round(stdp,2),  round(adj,2)))

labs<-(e.breaks)
e.breaks<-abs(e.breaks-adj)

scale.e<-(max(w$chl)/max(c(t_rect$y2, h_rect$y2, t_4_rect$y2)))


plot_e<- ggplot()+ theme_bw()+
geom_segment(data=t_4_rect, mapping=aes(x=start, xend=end, yend=y2*scale.e, y=-Inf), linetype ="dashed", color=rect_fill_outside, alpha=.5)+  
geom_hline(yintercept=(mean(w$chl)), data=w, linetype="dashed", color =chcolor)+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), color=rect_fill_non, fill=rect_fill_non, alpha=.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), color=rect_fill, fill=rect_fill, alpha=.5)+  
geom_point(data=w, aes(date, chl), color=chcolor, lwd=.6)+ 
geom_line(data=w, aes(date, chl), color=chcolor, lwd=0.4)+
scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.e, name=txt$ylab2,  breaks = e.breaks , labels= labs))+
labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)



          # Unused ideas...(failures)

# geom_rect_pattern(data=t_4_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), color=rect_fill_outside, fill=rect_fill_outside, pattern = 'crosshatch', alpha=0.5)+


# geom_rect(data=t_4_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), color=rect_fill_outside, fill=rect_fill_outside, alpha=0.5)+
# geom_rect_pattern(data=t_4_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), color=rect_fill_outside, fill=rect_fill_outside,  aes(pattern = 'magick', pattern_fill= 'grey30', pattern_type="horizontal3", width =1, height=1), alpha=0.5)+

# geom_rect_pattern(data=t_4_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), color=rect_fill_outside, fill=rect_fill_outside, pattern = 'magick', type ='horizontal3',pattern_fill= "grey30", alpha=0.5, width=1, height=1)+  
  
# geom_rect_pattern(data=t_4_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.e), pattern ='magick',  pattern_type='horizontal3',  pattern_angle=0, pattern_alpha=0.5, height=t_4_rect$y2*scale.e)+    
  
# geom_vline(data=t_4_rect, mapping=aes(xintercept=start, yintercept=y2*scale.e), linetype ="dotted", color=rect_fill_outside)+  


# geom_line(stat = "summary", fun.y = "mean", colour = "red", data=w, aes(date, chl))+ 
# geom_line(colour = "green", data=w, aes(date, chl))+
# geom_smooth(data=w, aes(date, chl), color=chcolor, lwd=.5)+
# stat_smooth(data=w, aes(date, chl), formula = w$chl ~ s(w$date, k = nrow(w)-1), method = "gam", se = FALSE, color="black")+
# scale_y_continuous(name =txt$ylab)+

 # aes(pattern = level, pattern_angle = level, pattern_spacing = level), fill  = 'white',
 #    colour          = 'black', 
 #    pattern_density = 0.35, 
 #    pattern_fill    = 'black',
 #    pattern_colour  = 'black'
 #  ) +

plot_list$e<-plot_e
```


#plot_f

```{r}
gc()
txt<-ftxt

w<-inner_join(x,y, by='date') %>% inner_join(., z, by='date' ) %>% select(., - ef)
h_rect<-rects$h
t_rect<-rects$t
t_4_rect<-rects$t_4

stdp<-1013.25
ff<-10
adj<-stdp+ff*(stdp-min(h_rect$y2))

h_rect$y2<-abs(h_rect$y2-adj)
t_rect$y2<-abs(t_rect$y2-adj)
t_4_rect$y2<-abs(t_4_rect$y2-adj)

f.breaks<-c( 872, 900, 920, plyr::round_any((944+920)/2, 5, f=floor), plyr::round_any((964+945)/2, 5, f=ceiling), plyr::round_any((979+965)/2,5, f=floor), 980, 1000) %>% round(., 0) %>% append(., c(round(stdp,2),  round(adj,2)))

labs<-(f.breaks)
f.breaks<-abs(f.breaks-adj)

scale.f<-(max(w$sst)/max(c(t_rect$y2, h_rect$y2, t_4_rect$y2)))

plot_f<- ggplot()+ theme_bw()+
geom_segment(data=t_4_rect, mapping=aes(x=start, xend=end, yend=y2*scale.f, y=-Inf), linetype ="dashed", color=rect_fill_outside, alpha=.5)+  
geom_hline(yintercept=(mean(w$sst)), data=w, linetype="dashed", color =tcolor)+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.f), color=rect_fill_non, fill=rect_fill_non, alpha=.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.f), color=rect_fill, fill=rect_fill, alpha=.5)+  
geom_point(data=w, aes(date, sst), color=tcolor, lwd=.6)+ 
geom_line(data=w, aes(date, sst), color=tcolor, lwd=0.4)+
scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.f, name=txt$ylab2,  breaks = f.breaks , labels= labs))+
labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)

plot_list$f<-plot_f
```


#plot_g

```{r}
txt<-gtxt

w<-inner_join(x,y, by='date') %>% inner_join(., z, by='date' ) %>% select(., - ef)
h_rect<-rects$h
t_rect<-rects$t
t_4_rect<-rects$t_4

stdp<-1013.25
ff<-2
adj<-stdp+ff*(stdp-min(h_rect$y2))

h_rect$y2<-abs(h_rect$y2-adj)
t_rect$y2<-abs(t_rect$y2-adj)
t_4_rect$y2<-abs(t_4_rect$y2-adj)

g.breaks<-c( 872, 900, 920, plyr::round_any((944+920)/2, 5, f=floor), plyr::round_any((964+945)/2, 5, f=ceiling), plyr::round_any((979+965)/2,5, f=floor), 980, 1000) %>% round(., 0) %>% append(., c(round(stdp,2),  round(adj,2)))

labs<-(g.breaks)
g.breaks<-abs(g.breaks-adj)

scale.g<-(max(w$avg)/max(c(t_rect$y2, h_rect$y2, t_4_rect$y2)))

plot_g<- ggplot()+ theme_bw()+
geom_segment(data=t_4_rect, mapping=aes(x=start, xend=end, yend=y2*scale.g, y=-Inf), linetype ="dashed", color=rect_fill_outside, alpha=.5)+  
geom_hline(yintercept=(mean(w$avg)), data=w, linetype="dashed", color ="black")+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.g), color=rect_fill_non, fill=rect_fill_non, alpha=.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=-Inf, ymax=y2*scale.g), color=rect_fill, fill=rect_fill, alpha=.5)+  
geom_point(data=w, aes(date, avg), color="black", lwd=.6)+ 
geom_line(data=w, aes(date, avg), color="black", lwd=0.4)+
scale_y_continuous(name =txt$ylab, sec.axis = sec_axis(~./scale.g, name=txt$ylab2,  breaks = g.breaks , labels= labs))+
labs(title=txt$title, caption = txt$capt)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months", position = "top")+
theme(axis.title.x=element_blank(), plot.tag = element_text(face = "bold"))+
labs(tag = txt$panel)

plot_list$g<-plot_g

```

```{r}

setwd(wd)
setwd(fig)
pdf("export_flux_figure.pdf", height=33 , width =14)
cowplot::plot_grid(plotlist = plot_list, nrow=7, ncol=1)
dev.off()
```



# single plot

```{r}

# w<-inner_join(x,y, by='date') %>% inner_join(., z,  by='date' ) %>% select(., - ef)
# below wotrsk but vairble need to be scaled....

# w<-gather(w, key = "variable", value = "value", -date)
# plot_all<- ggplot(data=w)+ geom_line(aes(x = date, y=value)) +theme_bw()+facet_wrap(~variable , ncol=1)

plot_list<-vector(mode="list", length=7)
plot_list$a<-plot_a
plot_list$b<-plot_b
plot_list$c<-plot_c
plot_list$d<-plot_d
plot_list$f<-plot_f
plot_list$g<-plot_g




```




```{r}



geom_line(aes(y=chlorophyll * scale.chla), color=fcolor) +
  geom_line(aes(y=celsius), color=tcolor) +
  xlab("Date") +
  ggtitle("SST and Chlorophyll-a") +
  scale_x_datetime(date_breaks=('2 days'))+
  scale_y_continuous(name ="SST (°C)", sec.axis = sec_axis(~./scale.chla,name="Chlorophyll-a [μg/L]"))+
```


```{r}

plot<- ggplot()+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=y2), color=rect_fill_non, fill=rect_fill_non, alpha=0.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=y2), color=rect_fill, fill=rect_fill, alpha=0.5)+
geom_line(data=x, aes(date, avg), color=line_col, lwd=1)+
theme_bw()+
ylab("Mean export flux (mgC/m^2/day)")+
scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
labs(title=lab_avg, caption = '8-Day resolution: Non-lagged EF. Colored lines are cyclones that pass within export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " " ')+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
theme(axis.title.x=element_blank())

# labs(title=lab_avg, caption = '8-Day resolution: Non-lagged EF. Colored lines are cyclones that pass within 400km^2 box around station 3.5: Orange = Hurricane strength,  Blue = less than " " ')+


```


# scaling following grl suplmentarty figure


```{r}
setwd(fig)
# options(device ="X11")# for viewing graphs on large window

###plot options ##
# best thing is tho calculate hour average from raw data

x<-cruise_data # to make typing easier 

# x$wind<-x$wind*0.514444 # knots ->m/s
# x = x[seq(1, nrow(x), 15), ] # subset every 15 minutes for cleaner image
# x = x[seq(1, nrow(x), 30), ] #
#x = x[seq(1, nrow(x), 60), ] # subset every 60 minutes

mydates <- interval(start = min(x$time), end = "2018-06-25") # subset x-axis
x<- x[which(time %within% mydates),]
rm(mydates)

scale.wind<-max(x$celsius) / max(x$wind)
scale.chla<-max(x$celsius) / max(x$chlorophyll)

rect_color<-"grey89"
tcolor<-"red"
fcolor<-"darkgreen"
#wcolor<-"cyan"

#### f1 rectangles #####
# adjust geom etx for various plots

# change the geom text value to change position of lables

# high for wind:
# geom_text(data=rects, x=centered, label=rects[,2], y =32.5, angle =90) +

# centered for clophyll 
# geom_text(data=rects, x=centered, label=rects[,2], y =16.5, angle =90) +


# 3.5 for wind plot


f1 <- ggplot(x, aes(x = time)) + geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_color) +
  geom_text(data=rects, x=centered, label=rects[,2], y =34, angcle =0) +
  theme_bw()


#### f3 temp & chl-a ####
f3<-f1 +
  geom_line(aes(y=chlorophyll * scale.chla), color=fcolor) +
  geom_line(aes(y=celsius), color=tcolor) +
  xlab("Date") +
  ggtitle("SST and Chlorophyll-a") +
  scale_x_datetime(date_breaks=('2 days'))+
  scale_y_continuous(name ="SST (°C)", sec.axis = sec_axis(~./scale.chla,name="Chlorophyll-a [μg/L]"))+
  #scale_y_continuous(name ="Chlorophyll-a [μg/L]", sec.axis = sec_axis(~./scale.chla,name="°C")) + 
  theme(
    panel.background = element_rect(fill = NA),
    panel.ontop = FALSE
  ) + 
  scale_x_datetime(date_labels = "%m/%d", date_breaks="2 days", date_minor_breaks = "1 days") +
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.ticks.y.left = element_line(color = tcolor),
        axis.text.y.left = element_text(color = tcolor), 
        axis.title.y.left = element_text(color = tcolor)
  ) +
  
  theme(axis.ticks.y.right = element_line(color = fcolor),
        axis.text.y.right = element_text(color = fcolor), 
        axis.title.y.right = element_text(color = fcolor)
  )+

  theme(
    panel.background = element_rect(fill = NA),
    panel.ontop = FALSE
  )



# add panel text




```   

```{r}


```



```{r}
plot<- ggplot()+
geom_rect(data=t_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=y2), color=rect_fill_non, fill=rect_fill_non, alpha=0.5)+
geom_rect(data=h_rect, mapping=aes(xmin=start, xmax=end, ymin=y1, ymax=y2), color=rect_fill, fill=rect_fill, alpha=0.5)+
geom_line(data=x, aes(date, avg), color=line_col, lwd=1)+
theme_bw()+
ylab("Mean export flux (mgC/m^2/day)")+
scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
labs(title=lab_avg, caption = '8-Day resolution: Non-lagged EF. Colored lines are cyclones that pass within export flux box around station 3.5: Orange = Hurricane strength,  Blue = less than " " ')+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.caption =element_text(hjust = 0.5))+
scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
theme(axis.title.x=element_blank())
```


```{r}
setwd(wd)
setwd(fig)

pdf("poc_averages_st3.5_with_TCs_within_200km.pdf", height=8.5 , width =16)
plot
dev.off()

```




# plotting v2 fx here f needed

```{r}


# setwd(wd)
# setwd(robj)
# 
# # data<-read_rds("vgpm_integrated_20220512.R")
# data<-read_rds("vgpm_integrated_all_years_202200607.R")


# f.poc_plots<-function(x){}
# see https://stackoverflow.com/questions/9469504/access-and-preserve-list-names-in-lapply-function


plots_avg<-vector(mode="list", length(data))
plots_total<-vector(mode="list", length(data))
station_number<-c("1", "2", "3", "3.5", "4", "5")
window_area<-c(round((data$st1$`window_area (m^2)`[1]*1e-6),0), round((data$st2$`window_area (m^2)`[1]*1e-6),0), round((data$st3$`window_area (m^2)`[1]*1e-6),0), round((data$st3.5$`window_area (m^2)`[1]*1e-6),0), round((data$st4$`window_area (m^2)`[1]*1e-6),0), round((data$st5$`window_area (m^2)`[1]*1e-6),0))



rects<- data.frame(x1=seq(as.Date('2002-05-15'), length.out=20, by="years"),
        x2=seq(as.Date('2002-11-30'),length.out=20, by="years"))

rects$y1<-Inf
rects$y2<-Inf

# rectangel parameters:
rect_color<-NA
sz<-0.25
alph<-.25
rect_fill<-"cornsilk1"   

  
# x<-data$st5
x<-data[[i]]
lab_avg<-paste0("Station ", station_number[i], ":", " Average Export Flux - ", window_area[i], " km^2 area")
lab_total<-paste0("Station ", station_number[i], ":", " Total Export Flux - ", window_area[i], " km^2 area")

x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

# x$l<-log10(x$ef)
plots_total[[i]]<- ggplot(x, aes(x=date, y=ef)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[7], xmax = rects$x2[7] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[8], xmax = rects$x2[8] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[9], xmax = rects$x2[9] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[10], xmax = rects$x2[10] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[11], xmax = rects$x2[11] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[12], xmax = rects$x2[12] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[13], xmax = rects$x2[13] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[14], xmax = rects$x2[14] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[15], xmax = rects$x2[15] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[16], xmax = rects$x2[16] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[17], xmax = rects$x2[17] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[18], xmax = rects$x2[18] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[19], xmax = rects$x2[19] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[20], xmax = rects$x2[20] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_point()+
  theme_bw()+
  ylab("Export flux (kg C/day)")+
  labs(title=lab_total,
  caption = "8-Day resolution: Non-lagged EF. Colored boxes: Climatological Cyclone Season (05-15 to 11-30)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())
 

#, date_minor_breaks = "1 month"

 # xlab("8-day Integration")+
plots_avg[[i]]<- ggplot(x, aes(x=date, y=avg)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[7], xmax = rects$x2[7] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[8], xmax = rects$x2[8] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[9], xmax = rects$x2[9] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[10], xmax = rects$x2[10] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[11], xmax = rects$x2[11] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[12], xmax = rects$x2[12] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[13], xmax = rects$x2[13] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[14], xmax = rects$x2[14] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[15], xmax = rects$x2[15] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[16], xmax = rects$x2[16] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[17], xmax = rects$x2[17] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[18], xmax = rects$x2[18] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[19], xmax = rects$x2[19] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[20], xmax = rects$x2[20] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_point()+
  theme_bw()+
  ylab("Mean export flux (mgC/m^2/day)")+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  labs(title=lab_avg, caption = "8-Day resolution: Non-lagged EF. Colored boxes: Climatological Cyclone Season (05-15 to 11-30)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())
   
rm(x)         
                       
}
cowplot::plot_grid(plotlist = a1, nrow=3, ncol=1)
```


```{r}
library(cowplot)
setwd(wd)
setwd(fig)
a1<-list(plots_avg[[1]], plots_avg[[2]], plots_avg[[3]])
a2<-list(plots_avg[[4]], plots_avg[[5]], plots_avg[[6]])

pdf("poc_averages_1.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = a1, nrow=3, ncol=1)
dev.off()

pdf("poc_averages_2.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = a2, nrow=3, ncol=1)
dev.off()

t1<-list(plots_total[[1]], plots_total[[2]], plots_total[[3]])
t2<-list(plots_total[[4]], plots_total[[5]], plots_total[[6]])

pdf("poc_totals_1.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = t1, nrow=3, ncol=1)
dev.off()

pdf("poc_totals_2.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = t2, nrow=3, ncol=1)
dev.off()



```



acet_wrap(~ clarity



 #plotting (old cod fro chl, tmep and staion boxes) suplemtary figure

```{r}
i<-4
x<-data[[i]]
x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

rect_color<-"red"

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

t<- ggplot(x, aes(x=date, y=ef)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=NA, colour=rect_color, size=0.5, alpha=0.2)+
  geom_point()+
  ylab("Export flux (kg C/day)")+
  labs(title=lab_total,
  caption = "8-Day resolution: non-lagged EF")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())



```


```




