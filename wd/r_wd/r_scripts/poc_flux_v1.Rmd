# To do improvements:

*fix 'f.ef_data'
**read files better
*** read file dont' open
** apply NA after subset
** change so lapply works

*add date function in file nameing

* improve directory structure

# Setup
## Directories and defaults
Use r proj file for relative directories
see: https://yihui.org/knitr/options/


```{r setup}
rm(list=ls())
# relative directories
robj<-"r_objects"
fig<-"../../figures"

# data_poc<-"../../data/POC_Flux_data_sets/4km_derived_daily_export_flux/ef_2018/2018"
data_poc<-"/home/brandon/vestawd/omz/data/POC_Flux_data_sets/8_day_VGPM_NPP_xyz/window"
data_poc_all<-"../../data/POC_Flux_data_sets/annual_vgpm_NPP_hdf4"

output<-"../../output"

#absolute directory
# drop_img<-"/home/brandon/Dropbox/MERCED/dissertation/presentations/images"

knitr::opts_chunk$set(echo =FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

## packages

Installed custom hurdat package using r markdown menu
* download  tar from archive as no longer maintained on cran repository
* https://cran.r-project.org/src/contrib/Archive/HURDAT/
+ include as git submodule instead

```{r}
f.ipak <- function(pkg){
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}

# packages<-c("stars", "gridExtra", "cowplot", "sf", "ggspatial","stringr","sp", "rgdal",  "rgeos", "raster","readr" ,"tidyverse", "ggplot2", "lubridate",  "ggthemes", "data.table", "reshape2", "RColorBrewer", "marmap", "extrafont", "oce", "MODIS", "measurements")  # set packages here

# tidyverse: is all of the following packages: ggplot2, dplyr, tidyr, readr, purr, tibble, sringr, & forcats.

packages<-c("sp", "rgdal",  "rgeos", "raster", "readr", "tidyverse", "lubridate",  "ggthemes",  "sf", "cmocean", "ncdf4", "RNetCDF",  "plot3D", "tidync", "devtools", "stars", "ncmeta", "maps", "oce", "data.table", "fasterize", "RStoolbox", "scales", "purrr")

# "HURDAT",

f.ipak(packages)
# lapply(packages, require, character.only = TRUE)
# rm(f.ipak, packages)
print(paste0("Current Working Directory is ", getwd()))

wd<-getwd()
```

## subset
copied from graphing , should make a  function....
```{r}
setwd( "/home/brandon/vestawd/omz/wd/r_wd")
setwd(robj)
# 
stations_positions_list<-readRDS("OC1806A_stations_positions_list.R")

st<-stations_positions_list[[3]][1,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=20.50006 +lon_0=-106.5006" )
circle_1<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
rm(flat, st)

st<-stations_positions_list[[3]][2,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=16.49850 +lon_0=-107.2007" )
circle_2<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
rm(flat, st)

st<-stations_positions_list[[3]][3,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=15.99901 +lon_0=-108.5020" )
circle_3<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][4,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=18.5005 +lon_0=-108.502" )
circle_3.5<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][5,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=21.50061 +lon_0=-109.4999" )
circle_4<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

st<-stations_positions_list[[3]][6,cbind(2,3)]
st<-sf::st_as_sf(st, coords =c("longitude", "latitude"),  crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
flat<-sf::st_transform(st, "+proj=aeqd +lat_0=24.69887 +lon_024.69887" )
circle_5<-sf::st_buffer(flat, dist=100000)%>%sf::st_transform(., "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

rm(st, flat, stations_positions_list)


#make alsit for next steps

station_circle_list<-list(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5 )
rm(circle_1, circle_2, circle_3, circle_3.5, circle_4, circle_5)

f.bbox<-function(x){
z<-st_bbox(x)
z<-data.frame(lon= c(z[[1]], z[[3]]), lat = c(z[[2]], z[[4]])) #%>% st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
return(z)
}
station_box_list<-lapply(station_circle_list, f.bbox)
names(station_box_list)<-c("st1", "st2", "st3", "st3.5", "st4", "st5")
rm(station_circle_list)


```

# first attempt:
## functions

```{r}
f.ef<-function(NPP){
  # units =mg C m−2 d−1
  EF =(0.284 * NPP + 9.75)
  EF= round(EF, 3)
  return(EF)
}

f.vgpm_cal<-function(vgpm){
  # VGPM-CAL = 10^(LOG10(VGPM)) − 0.1924. 
  NPP= 10^(log10(vgpm)) - 0.1924
  return(NPP)
}

f.grid_square_area2<-function(x) {
  x.area<-vector(mode="numeric", length = nrow(x)) 
  
  for(i in 1:length(x.area)){
    bbox<-st_bbox(x[[2]][[i]])
    box<-vector(mode="numeric", length=4)
    names(box)<-c("xmin","ymin","ymax", "xmax")
    box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
    box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
    box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
    box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
    x.area[i]<- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                         proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,) %>% round(., -1)
  }
  sum_grid_area<-sum(x.area)
  x$value<-x.area
  y<-vector(mode = "list", length=2)
  names(y)<-c("grid_area", "sum_grid_area")
  y$grid_area<-x
  y$sum_grid_area<-sum_grid_area
  
    return(y)}

f.net_ef<-function(x){
  # grid_area<-f.grid_square_area2(x.sf)
  x$value<-f.vgpm_cal(x$value)
  x$value<-f.ef(x$value)
  y<-f.grid_square_area2(x)
  EF<-(x*y$grid_area)
  sum_grid_area<<-y$sum_grid_area
  return(sum(EF$value))
}

f.ef_data<-function(z){

vgpm_integrated<-as.data.frame(matrix(ncol = 13, nrow =length(files)))
names(vgpm_integrated)<-c("date",  "vgpm_median (mgC/m^2/day)", "vgpm_mean (mgC/m^2/day)", "cal_vgpm_median (mgC/m^2/day)", "cal_vgpm_mean (mgC/m^2/day)", "export_flux_median (mgC/m^2/day)",  "export_flux_mean (mgC/m^2/day)", "net_vgpm_npp (mgC/day)", "window_area (m^2)", "sum_grid_area (m^2)", "vgpm_variance (mgC/m^2/day)", "total_export_flux (mgC/day)", "mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)" )
  
for(i in 1:length(files)){
 
  file<-files[i]
  t<-read_delim(file, col_select = c(1:3))
  t$value[t$value == -9999] <- NA
  
  y<- subset(t, lat >= min(z$lat) & lat <= max(z$lat)  & lon >= min(z$lon) & lon <= max(z$lon),   select=c(value, lon, lat))
  rm(t)
  x<-y$value
  x.sf<-y %>%st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
  rm(y)
 
  bbox<-st_bbox(x.sf)
  box<-vector(mode="numeric", length=4)
  names(box)<-c("xmin","ymin","ymax", "xmax")
  box$ymin<-round(bbox$ymin[[1]]-(5/120),3)
  box$ymax<-round(bbox$ymax[[1]]+(5/120),3)
  box$xmin<-round(bbox$xmin[[1]] +-(5/120),3)
  box$xmax<-round(bbox$xmax[[1]] +(5/120),3)
  
  
area <- rgeos::bbox2SP(n = box$ymax[[1]], s = box$ymin[[1]], w = box$xmin[[1]], e = box$xmax[[1]],
                         proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>% st_as_sf(.,) %>% st_area(.,)
  rm(box, bbox)
  
  t<-str_split(file, '\\.')
  t<-t[[1]][2]
  t<-str_split(t, "")
  y<-c(t[[1]][1:4])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)   
  yd<-c(t[[1]][5:7])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)
  origin<-toString(c(y,"-01-01")) %>% gsub(",","",.) %>% gsub(" ","",.)
  
# claulated vlaes:
net_ef<-f.net_ef(x.sf)

  y<- f.grid_square_area2(x.sf)
  q<-x.sf*y$grid_area
  net_npp<-sum(q$value)
  rm(q,z)

     

vgpm_integrated[i,1]<-as.character(as.Date(as.numeric(yd), origin=origin)) # date  
vgpm_integrated[i,2]<-median(x) # vgpm_median
vgpm_integrated[i,3]<-mean(x) # vgpm_mean
vgpm_integrated[i,4]<-f.vgpm_cal(vgpm_integrated[i,2])# cal_vgpm_median
vgpm_integrated[i,5]<-f.vgpm_cal(vgpm_integrated[i,3])# cal_vgpm_mean
vgpm_integrated[i,6]<-f.ef(vgpm_integrated[i,4]) # export_flux_median
vgpm_integrated[i,7]<-f.ef(vgpm_integrated[i,5]) # export_flux_mean
vgpm_integrated[i,8]<-net_npp # net_vgpm_npp (mgC/day)
vgpm_integrated[i,9]<-as.numeric(area) # window_area (m^2) 
vgpm_integrated[i,10]<-sum_grid_area # sum_grid_area (m^2)
vgpm_integrated[i,11]<-var(x) # vgpm_variance
vgpm_integrated[i,12]<-net_ef # total_export_flux (mgC/day)
vgpm_integrated[i,13]<-vgpm_integrated[i,12]/vgpm_integrated[i,10] # mean export flux (mgC/m^2/day) for sample window

  
}

  
n<-names(vgpm_integrated)
vgpm_integrated<-dplyr::select(vgpm_integrated, n[1], n[12], n[13], n[6], n[7], n[9], n[10], n[8],n[2], n[3],  n[11], n[4], n[5] )

return(vgpm_integrated)}

f.grided_ef<-function(x){
  x$value<-f.vgpm_cal(x$value)
  x$value<-f.ef(x$value)
  return(x)
}

f.ef_plots<-function(z) {

ef_per_date<-vector(mode = "list", length = length(files))
nl<-vector(mode = "character", length = length(files))
  for(i in 1:length(files)){
  file<-files[i]
  t<-str_split(file, '\\.')
  t<-t[[1]][2]
  t<-str_split(t, "")
  y<-c(t[[1]][1:4])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)   
  yd<-c(t[[1]][5:7])%>% toString(.) %>% gsub(",","",.) %>% gsub(" ","",.)
  origin<-toString(c(y,"-01-01")) %>% gsub(",","",.) %>% gsub(" ","",.)
  nl[i]<-as.character(as.Date(as.numeric(yd), origin=origin))
}

names(ef_per_date)<-nl  

  for(i in 1:length(files)){

  file<-files[i]
  t<-read_delim(file, col_select = c(1:3))
  t$value[t$value == -9999] <- NA
  
  y<- subset(t, lat >= min(z$lat) & lat <= max(z$lat)  & lon >= min(z$lon) & lon <= max(z$lon),   select=c(value, lon, lat))
  rm(t)
  x.sf<-y %>%st_as_sf(., coords = c("lon", "lat" ), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
  rm(y)
  
  ef_per_date[[i]]<-f.grided_ef(x.sf)
  
}

return(ef_per_date)}

```

## first run - data & saving
- edit this code chunk for lapply and nameing conventions

```{r}
setwd( "/home/brandon/vestawd/omz/wd/r_wd")
setwd(data_poc)

t.start<-Sys.time()

files<-list.files()

z<-station_box_list[[1]]
st1<-f.ef_data(z)

z<-station_box_list[[2]]
st2<-f.ef_data(z)

z<-station_box_list[[3]]
st3<-f.ef_data(z)

z<-station_box_list[[4]]
st3.5<-f.ef_data(z)

z<-station_box_list[[5]]
st4<-f.ef_data(z)

z<-station_box_list[[6]]
st5<-f.ef_data(z)

data<-vector(mode="list", length=length(station_box_list))

names(data)<-names(station_box_list)
data$st1<-st1
data$st2<-st2
data$st3<-st3
data$st3.5<-st3.5
data$st4<-st4
data$st5<-st5
rm(st1, st2, st3, st3.5, st4, st5)
rm(station_box_list) 



setwd( "/home/brandon/vestawd/omz/wd/r_wd")
setwd(robj)
saveRDS(data, "vgpm_integrated_20220512.R")
# rm(data) #can't write csvs if this is dleated


t.end<-Sys.time()
 r1.time<-t.end-t.start
# 
# 
# setwd( "/home/brandon/vestawd/omz/wd/r_wd")
# t.start<-Sys.time()
# setwd(data_poc)
# files<-list.files()
# 
# ef_grids<-lapply(station_box_list, f.ef_plots)
# setwd( "/home/brandon/vestawd/omz/wd/r_wd")
# setwd(robj)
# saveRDS(ef_grids, "ef_grids_20220512.R")
# t.end<-Sys.time()
# r2.time<-t.end-t.start



```

## 2nd attempt - data & saving


```{r}
file<-(file.path(data_d, "odz_atlas/nc_depth_DIVA.nc"))
# q<-c("maxFODZ", "topDepth", "thickness", "botDepth")
q<-c("topDepth")
diva_depth.odz<-tidync(file)%>% activate(c("D0,D1")) %>% hyper_tibble(select_var =q)
rm(file, q)

odz<-diva_depth.odz %>% sf::st_as_sf(., coords = c("Longitude","Latitude"), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84")%>%
st_crop(., xmin = function_variables$h.lon_min,ymin= function_variables$h.lat_min, xmax=function_variables$h.lon_max, ymax= function_variables$h.lat_max )

rm(diva_depth.odz, file) # for now
gc()


```


### save csv's

### read in data file, so as not have to re run code
```{r}
setwd(robj)
data<-read_rds("vgpm_integrated_20220512.R")

```


```{r}

setwd( "/home/brandon/vestawd/omz/wd/r_wd")
setwd(output)

for(i in 1:length(data)){
fn<-paste0(names(data)[i], "_8day_vgpm_to_export_flux", ".csv")
# write.csv(data[[i]], fn, row.names = FALSE)}
readr::write_csv(data[[i]], fn)}
# write_excel_csv2(data[[i]], fn)}
# 

for(i in 1:length(data)){
fn<-paste0(names(data)[i], "_8day_vgpm_to_export_flux", ".txt")
# write.csv(data[[i]], fn, row.names = FALSE)}
write_tsv(data[[i]], fn, col_names = TRUE)}

vars<-names(data$st1)

fileConn<-file("variable_names.txt")
writeLines(vars, fileConn)
close(fileConn)

t.end<-Sys.time()

# f<-(paste0("data run time is ", r1.time," grid run time is ", r2.time, " and finshed at ", t.end ))
f<-(paste0("data run time is ", r1.time," and finshed at ", t.end ))

fileConn<-file("run_time.txt")
writeLines(vars, fileConn)
close(fileConn)

# print(paste0("grids  time is ", r2.time))

# system('shutdown')

```


# plotting v1
```{r}
setwd(wd)
setwd(robj)

# data<-read_rds("vgpm_integrated_20220512.R")
data<-read_rds("vgpm_integrated_all_years_202200607.R")

x<-data$st5
x$date<-ymd(x$date)

x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

# x$l<-log10(x$ef)
total<- ggplot(x, aes(x=date, y=ef)) +
  geom_point()+
  ylab("Export flux (kg C/day)")+
  xlab("8-day Integration")+
  labs(title="Station 3.5 Total Export flux for 40,000 km^2 area",
  caption = "2018- Tropical Cyclone Season: non-lagged EF")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))


average<- ggplot(x, aes(x=date, y=avg)) +
  geom_point()+
  ylab("Mean export flux (mgC/m^2/day)")+
  xlab("8-day Integration")+
  labs(title="Station 3.5 Average Export flux for 40,000 km^2 area",
       caption = "2018- Tropical Cyclone Season: non-lagged EF")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))

```



#plotting v2

```{r}


# setwd(wd)
# setwd(robj)
# 
# # data<-read_rds("vgpm_integrated_20220512.R")
# data<-read_rds("vgpm_integrated_all_years_202200607.R")


# f.poc_plots<-function(x){}
# see https://stackoverflow.com/questions/9469504/access-and-preserve-list-names-in-lapply-function


plots_avg<-vector(mode="list", length(data))
plots_total<-vector(mode="list", length(data))
station_number<-c("1", "2", "3", "3.5", "4", "5")
window_area<-c(round((data$st1$`window_area (m^2)`[1]*1e-6),0), round((data$st2$`window_area (m^2)`[1]*1e-6),0), round((data$st3$`window_area (m^2)`[1]*1e-6),0), round((data$st3.5$`window_area (m^2)`[1]*1e-6),0), round((data$st4$`window_area (m^2)`[1]*1e-6),0), round((data$st5$`window_area (m^2)`[1]*1e-6),0))



rects<- data.frame(x1=seq(as.Date('2002-05-15'), length.out=20, by="years"),
        x2=seq(as.Date('2002-11-30'),length.out=20, by="years"))

rects$y1<-Inf
rects$y2<-Inf

# rectangel parameters:
rect_color<-NA
sz<-0.25
alph<-.25
rect_fill<-"cornsilk1"


for(i in 1:length(data)) {

  
# x<-data$st5
x<-data[[i]]
lab_avg<-paste0("Station ", station_number[i], ":", " Average Export Flux - ", window_area[i], " km^2 area")
lab_total<-paste0("Station ", station_number[i], ":", " Total Export Flux - ", window_area[i], " km^2 area")

x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

# x$l<-log10(x$ef)
plots_total[[i]]<- ggplot(x, aes(x=date, y=ef)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[7], xmax = rects$x2[7] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[8], xmax = rects$x2[8] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[9], xmax = rects$x2[9] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[10], xmax = rects$x2[10] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[11], xmax = rects$x2[11] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[12], xmax = rects$x2[12] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[13], xmax = rects$x2[13] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[14], xmax = rects$x2[14] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[15], xmax = rects$x2[15] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[16], xmax = rects$x2[16] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[17], xmax = rects$x2[17] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[18], xmax = rects$x2[18] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[19], xmax = rects$x2[19] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[20], xmax = rects$x2[20] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_point()+
  theme_bw()+
  ylab("Export flux (kg C/day)")+
  labs(title=lab_total,
  caption = "8-Day resolution: Non-lagged EF. Colored boxes: Climatological Cyclone Season (05-15 to 11-30)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())
 

#, date_minor_breaks = "1 month"

 # xlab("8-day Integration")+
plots_avg[[i]]<- ggplot(x, aes(x=date, y=avg)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[7], xmax = rects$x2[7] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[8], xmax = rects$x2[8] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[9], xmax = rects$x2[9] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[10], xmax = rects$x2[10] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[11], xmax = rects$x2[11] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[12], xmax = rects$x2[12] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[13], xmax = rects$x2[13] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[14], xmax = rects$x2[14] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[15], xmax = rects$x2[15] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[16], xmax = rects$x2[16] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[17], xmax = rects$x2[17] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[18], xmax = rects$x2[18] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[19], xmax = rects$x2[19] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_rect(data =x ,  aes(xmin =rects$x1[20], xmax = rects$x2[20] , ymin = -Inf, ymax = Inf), fill=rect_fill, colour=rect_color, size=sz, alpha=alph)+
  geom_point()+
  theme_bw()+
  ylab("Mean export flux (mgC/m^2/day)")+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  labs(title=lab_avg, caption = "8-Day resolution: Non-lagged EF. Colored boxes: Climatological Cyclone Season (05-15 to 11-30)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_x_date(date_breaks = "1 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())
   
rm(x)         
                       
}

```


```{r}
library(cowplot)
setwd(wd)
setwd(fig)
a1<-list(plots_avg[[1]], plots_avg[[2]], plots_avg[[3]])
a2<-list(plots_avg[[4]], plots_avg[[5]], plots_avg[[6]])

pdf("poc_averages_1.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = a1, nrow=3, ncol=1)
dev.off()

pdf("poc_averages_2.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = a2, nrow=3, ncol=1)
dev.off()

t1<-list(plots_total[[1]], plots_total[[2]], plots_total[[3]])
t2<-list(plots_total[[4]], plots_total[[5]], plots_total[[6]])

pdf("poc_totals_1.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = t1, nrow=3, ncol=1)
dev.off()

pdf("poc_totals_2.pdf", height=8.5 , width =11)
cowplot::plot_grid(plotlist = t2, nrow=3, ncol=1)
dev.off()



```




creating boxes

```{r}



rects<- data.frame(x1=seq(as.Date('2002-05-15'), length.out=20, by="years"),
        x2=seq(as.Date('2002-11-30'),length.out=20, by="years"))

rects$y1<-Inf
rects$y2<-Inf
rects$x1[1]<-as.Date("2002-07-05")

rect_color<-"grey89"


ggplot(x, aes(x = time)) + 
  
geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=rect_color)
geom_rect(data =x ,  aes(xmin =rects$x1[2], xmax = rects$x2[2] , ymin = -Inf, ymax = Inf), fill=rect_color) +
geom_rect(data =x ,  aes(xmin =rects$x1[3], xmax = rects$x2[3] , ymin = -Inf, ymax = Inf), fill=rect_color) +
geom_rect(data =x ,  aes(xmin =rects$x1[4], xmax = rects$x2[4] , ymin = -Inf, ymax = Inf), fill=rect_color) +
geom_rect(data =x ,  aes(xmin =rects$x1[5], xmax = rects$x2[5] , ymin = -Inf, ymax = Inf), fill=rect_color) +
geom_rect(data =x ,  aes(xmin =rects$x1[6], xmax = rects$x2[6] , ymin = -Inf, ymax = Inf), fill=rect_color) +
theme_bw()



#old

# rects<-dplyr::inner_join(start, end, by="station")
# names(rects)<-c("x1", "station", "x2")
# rm(start, end)
# 
# rects$y1<-Inf
# rects$y2<-Inf
# centered<-((rects$x2-rects$x1)/2)+rects$x1
# rects$station<-c("Sta 1", "Sta 2", "Sta 3", "Sta 3.5", "Sta 4", "Sta 5" )
# rm(stations)
# 
# RECTS:

#                  x1 station                  x2  y1  y2
# 1 2018-06-09 20:00:00   Sta 1 2018-06-11 04:00:00 Inf Inf
# 2 2018-06-14 00:00:00   Sta 2 2018-06-15 18:00:00 Inf Inf
# 3 2018-06-16 10:00:00   Sta 3 2018-06-18 10:00:00 Inf Inf
# 4 2018-06-19 04:00:00 Sta 3.5 2018-06-20 02:00:00 Inf Inf
# 5 2018-06-20 20:00:00   Sta 4 2018-06-21 16:00:00 Inf Inf
# 6 2018-06-22 22:00:00   Sta 5 2018-06-23 16:00:00 Inf Inf
# > 
# 
# mayy 15
# 
# Nov 30
# 
# st<-as.charcter(year(min(data$st1$date))
# max(data$st1$date)





```



plotting (old cod fro chl, tmep and staion boxes) suplemtary figure

```{r}
i<-4
x<-data[[i]]
x$date<-ymd(x$date)
x<-select(x, date, `mean_export_flux (mgC/m^2/day) for_window_area (total/sum_grid_area)`, `total_export_flux (mgC/day)`)
# x<-select(x, date, `total_export_flux (mgC/day)` )

rect_color<-"red"

names(x)<-c("date", "avg", "ef")
x$ef<-x$ef/1000000

t<- ggplot(x, aes(x=date, y=ef)) +
  geom_rect(data =x ,  aes(xmin =rects$x1[1], xmax = rects$x2[1] , ymin = -Inf, ymax = Inf), fill=NA, colour=rect_color, size=0.5, alpha=0.2)+
  geom_point()+
  ylab("Export flux (kg C/day)")+
  labs(title=lab_total,
  caption = "8-Day resolution: non-lagged EF")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(plot.caption =element_text(hjust = 0.5))+
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", date_minor_breaks = "6 months")+
  theme(axis.title.x=element_blank())




```


## temp - for testing

```{r}
# setwd(data_poc)
# files<-list.files()
# 
# files<-list.files()
# i<-2
# file<-files[i]
# t<-read_delim(file, col_select = c(1:3))
# z<-station_box_list[[4]]

```


